<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sensy-One Zone Editor (HA)</title>
<style>
  :root{
    --ui: 1;
    --bg:#06070a; --panel:#0a0c11; --panel-2:#0b0d12; --ctrl:#10131a; --bd:#171b22;
    --fg:#e6eaf1; --muted:#9aa3ad; --ok:#22c55e; --err:#ef4444;
    --canvas:#0a0d12; --fov:#5f7cff;
    --z-norm:#69b1ff; --z-norm-fill:rgba(105,177,255,.16); --z-norm-dim:#3c6fa9; --z-norm-dim-fill:rgba(105,177,255,.08);
    --z-excl:#ff6b6b; --z-excl-fill:rgba(255,107,107,.16); --z-excl-dim:#a84848; --z-excl-dim-fill:rgba(255,107,107,.08);
    --pulse:#22c55e; --grid:#1e2431;
    --pad0: 10px; --gap0: 10px; --btnh0: 36px; --radius0: 12px;
    --fs0: 14px; --title0: 14px; --small0: 12px;
    --pad: calc(var(--pad0) * var(--ui));
    --gap: calc(var(--gap0) * var(--ui));
    --btnh: calc(var(--btnh0) * var(--ui));
    --radius: calc(var(--radius0) * var(--ui));
    --fs: calc(var(--fs0) * var(--ui));
    --title: calc(var(--title0) * var(--ui));
    --small: calc(var(--small0) * var(--ui));
    --base-canvas-w: 1040px;
    --base-canvas-h: 600px;
    --base-panel-w: 520px;
    --canvas-w: calc(var(--base-canvas-w) * var(--ui));
    --panel-w:  calc(var(--base-panel-w)  * var(--ui));
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font:var(--fs)/1.4 system-ui,Segoe UI,Roboto,Arial}

  .container{
    width:100%;
    min-height:100vh;
    margin:0 auto;
    padding:var(--pad);
    display:grid;
    gap:var(--gap);
    grid-template-columns: minmax(0, var(--canvas-w)) var(--panel-w);
    align-items:start;
    max-width: calc(var(--canvas-w) + var(--panel-w) + var(--gap));
  }

  @media (max-width:1150px){
    .container{
      grid-template-columns:1fr;
      gap:calc(var(--gap0) * 0.6);
      max-width:100%;
    }
  }

  .card{
    background:linear-gradient(180deg,var(--panel),var(--panel-2));
    border:1px solid var(--bd);
    border-radius:var(--radius);
    min-width:0;
  }

  .canvas-wrap{ padding:calc(6px * var(--ui)); }

  #canvas{
    display:block;
    width:var(--canvas-w);
    height:calc(var(--base-canvas-h) * var(--ui));
    max-width:100%;
    height:auto;
    aspect-ratio:1040/600;
    border-radius:calc(10px * var(--ui));
    touch-action:none;
    background:var(--canvas);
  }

  .panel{
    padding:var(--pad);
    display:flex;
    flex-direction:column;
    gap:var(--gap);
    overflow:auto;
  }

  .section{
    background:var(--ctrl);
    border:1px solid var(--bd);
    border-radius:calc(10px * var(--ui));
    padding:calc(8px * var(--ui));
    display:flex;
    flex-direction:column;
    gap:calc(6px * var(--ui));
    min-width:0;
  }

  .row{display:flex;gap:calc(6px * var(--ui));align-items:center;flex-wrap:nowrap}
  .row.equal>*{flex:1 1 0;min-width:0}

  input,button,select{
    height:var(--btnh);
    border-radius:calc(9px * var(--ui));
    border:1px solid #1a1f2a;
    background:#121620;
    color:var(--fg);
    padding:0 calc(10px * var(--ui));
    font:inherit;
    outline:none;
    min-width:0;
    max-width:100%;
  }
  input.readonly{ pointer-events:none; }
  button{cursor:pointer;transition:transform .04s,background-color .15s,border-color .15s;white-space:nowrap;text-align:center}
  .btn-primary{background:#151b28;border-color:#202638}
  .btn-primary:hover{background:#192132;border-color:#2a3550}
  .btn-primary:active{transform:translateY(1px)}
  .btn-plain{background:#121620;border-color:#1a1f2a}
  .btn-plain:hover{background:#151a24;border-color:#212836}

  select{
    cursor:pointer;appearance:none;-webkit-appearance:none;-moz-appearance:none;
    background-image: url("data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 10l5 5 5-5' stroke='%23cfd6e2' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    background-repeat:no-repeat;background-position:right calc(8px * var(--ui)) center;
    padding-right:calc(26px * var(--ui));
  }

  input[type=number]::-webkit-outer-spin-button,
  input[type=number]::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0; }
  input[type=number]{ -moz-appearance: textfield; appearance:textfield; }

  .title{font-size:var(--title);font-weight:600;color:#cfd6e2}

  .dot{width:calc(10px * var(--ui));height:calc(10px * var(--ui));border-radius:50%;background:#343a46;flex:0 0 auto}
  .dot.ok{background:var(--ok)} .dot.err{background:var(--err)}

  .input-with-icon{position:relative;width:100%;}
  .status-icon{
    position:absolute;
    left:calc(10px * var(--ui));
    top:50%;
    transform:translateY(-50%);
    pointer-events:none;
  }
  .status-input{
    width:100%;
    padding-left:calc(10px * var(--ui) + 12px * var(--ui) + 8px);
  }

  .zones{display:grid;grid-template-columns:1fr;gap:calc(6px * var(--ui))}
  .zone-btn{height:calc(34px * var(--ui));font-size:calc(13px * var(--ui))}
  .zone-btn.active{background:#151e2c;border-color:#2a3550}

  .row.equal .btn-primary, .row.equal .btn-plain { min-width:calc(96px * var(--ui)); }

  @media (max-width:480px){
    :root{ --btnh0: 34px; }
    .canvas-wrap{padding:calc(4px * var(--ui));}
    .panel{padding:calc(6px * var(--ui)); gap:calc(6px * var(--ui));}
    .zones{gap:calc(6px * var(--ui));}
  }
</style>
</head>
<body>
  <div class="container" id="container">
    <div id="canvasCard" class="card canvas-wrap">
      <canvas id="canvas"></canvas>
    </div>

    <div id="panelCard" class="card panel">
      <div class="section">
        <div class="title">Device</div>
        <div class="row">
          <select id="selDevices" aria-label="Device list" style="flex:1"></select>
        </div>
      </div>

      <div class="section">
        <div class="title">Status</div>
        <div class="row">
          <div class="input-with-icon">
            <span id="sDot" class="dot status-icon" aria-hidden="true"></span>
            <input id="sText" class="status-input readonly" value="Searching…" readonly />
          </div>
        </div>
      </div>

      <div class="section">
        <div class="title">Detection range</div>
        <div class="row equal">
          <input id="rangeInput" type="number" min="0" max="600" step="1" placeholder="0 – 600 cm" inputmode="numeric" />
          <button id="rangeSetBtn" class="btn-primary">Save</button>
        </div>
      </div>

      <div class="section">
        <div class="title">Zones</div>
        <div class="zones">
          <button class="zone-btn btn-plain" data-zone="1">Zone 1</button>
          <button class="zone-btn btn-plain" data-zone="2">Zone 2</button>
          <button class="zone-btn btn-plain" data-zone="3">Zone 3</button>
          <button class="zone-btn btn-plain" data-zone="excl">Exclusion Zone</button>
        </div>
      </div>

      <div class="section">
        <div class="title">Actions</div>
        <div class="row equal">
          <button id="saveBtn" class="btn-primary">Save</button>
          <button id="clearBtn" class="btn-plain">Clear</button>
        </div>
      </div>
    </div>
  </div>

<script>
(()=> {
  const BASE_CANVAS_W = 1040;
  const BASE_PANEL_W  = 520;
  const BASE_GAP      = 10;
  const SWITCH_BREAKPOINT = 1150;

  const $=(id)=>document.getElementById(id);
  const container=$('container');
  const canvasCard=$('canvasCard'), panelCard=$('panelCard');
  const cvs=$('canvas'), ctx=cvs.getContext('2d',{alpha:true,desynchronized:true});
  const sel=$('selDevices');
  const saveBtn=$('saveBtn'), clearBtn=$('clearBtn');
  const rangeInput=$('rangeInput'), rangeSetBtn=$('rangeSetBtn');
  const sDot=$('sDot'), sText=$('sText');
  const zoneBtns=[...document.querySelectorAll('.zone-btn')];

  const X_MIN=-520, X_MAX=520, Y_MIN=0, Y_MAX=600;
  const MAX_RANGE=600, MAX_POINTS=8, FOV_DEG=120, GRID=100;

  let cssW=0, cssH=0, dpr=1;
  let currentZone='1';
  const zones={'1':[],'2':[],'3':[],'excl':[]};
  const livePos={1:{x:NaN,y:NaN},2:{x:NaN,y:NaN},3:{x:NaN,y:NaN}};
  let selectedDevice=null;
  let entities=[];
  let detRange=MAX_RANGE;
  let saving=false;

  const BOOT_KEY='sensy_boot_reloaded_once';
  let liveTimer=null, livePauseDepth=0, liveInFlight=false;
  const LIVE_INTERVAL_MS=30;

  function updateUIScale() {
    const isTwoCols = window.matchMedia('(min-width:1151px)').matches;
    if (!isTwoCols) {
      document.documentElement.style.setProperty('--ui','1');
      return;
    }

    const vw = Math.max(320, window.innerWidth);
    const gutter = 32;
    const available = vw - gutter;
    const baseTotal = BASE_CANVAS_W + BASE_PANEL_W + BASE_GAP;
    const scale = Math.max(0.6, Math.min(1, available / baseTotal));
    document.documentElement.style.setProperty('--ui', String(scale));
  }

  function pauseLive(){ livePauseDepth++; if(liveTimer){ clearInterval(liveTimer); liveTimer=null; } }
  function resumeLive(){
    livePauseDepth=Math.max(0, livePauseDepth-1);
    if(livePauseDepth===0 && selectedDevice && !liveTimer){ liveTimer=setInterval(fetchTargets, LIVE_INTERVAL_MS); }
  }
  const pauseDuring=(fn)=>async(...a)=>{ pauseLive(); try{ return await fn(...a); } finally{ resumeLive(); } };

  function setStatus(kind,msg){
    sDot.className='dot status-icon'+(kind?(' '+kind):'');
    sText.value = msg;
  }

  async function api(path, body, {retryOnError=true, reloadOnError=true}={}){
    try{
      const r = await fetch(path, { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify(body||{}) });
      const text = await r.text();
      if(!r.ok){
        if ((r.status===500 || r.status===502) && retryOnError){ await new Promise(res=>setTimeout(res,200)); return api(path,body,{retryOnError:false,reloadOnError}); }
        if ((r.status===500 || r.status===502) && reloadOnError && !localStorage.getItem(BOOT_KEY)){ localStorage.setItem(BOOT_KEY,'1'); location.reload(); await new Promise(()=>{}); }
        let msg=r.status+' '+r.statusText; try{ const j=JSON.parse(text); msg=(j.error||msg)+(j.details?` (${j.details})`:''); }catch{}
        throw new Error(msg);
      }
      localStorage.removeItem(BOOT_KEY);
      const ct=r.headers.get('content-type')||'';
      return ct.includes('application/json') ? JSON.parse(text) : text;
    }catch(err){
      if(reloadOnError && !localStorage.getItem(BOOT_KEY)){ localStorage.setItem(BOOT_KEY,'1'); location.reload(); await new Promise(()=>{}); }
      throw err;
    }
  }

  const TPL_LIST = `
{% set out = namespace(items=[], ids=[]) %}
{% for s in states %}
  {% set dev = s.entity_id | device_id %}
  {% if dev and (device_attr(dev,'manufacturer') or '') == 'Sensy-One' and (dev not in out.ids) %}
    {% set name = device_attr(dev,'name_by_user') or device_attr(dev,'name') or dev %}
    {% set model = device_attr(dev,'model') or '' %}
    {% set out.items = out.items + [ { 'device_id': dev, 'name': name, 'model': model } ] %}
    {% set out.ids = out.ids + [ dev ] %}
  {% endif %}
{% endfor %}
{{ out.items | tojson }}
  `.trim();

  const targetsTemplate = (devId)=>(`
{% set dev = '`+devId+`' %}
{% set out = namespace(x1=0.0,y1=0.0,x2=0.0,y2=0.0,x3=0.0,y3=0.0) %}
{% for s in states if (s.entity_id | device_id) == dev %}
  {% set id = s.entity_id %}
  {% if id.endswith('target_1_x') %}{% set out.x1 = (s.state | float(0)) %}{% endif %}
  {% if id.endswith('target_1_y') %}{% set out.y1 = (s.state | float(0)) %}{% endif %}
  {% if id.endswith('target_2_x') %}{% set out.x2 = (s.state | float(0)) %}{% endif %}
  {% if id.endswith('target_2_y') %}{% set out.y2 = (s.state | float(0)) %}{% endif %}
  {% if id.endswith('target_3_x') %}{% set out.x3 = (s.state | float(0)) %}{% endif %}
  {% if id.endswith('target_3_y') %}{% set out.y3 = (s.state | float(0)) %}{% endif %}
{% endfor %}
{{ {'1': {'x': out.x1, 'y': out.y1}, '2': {'x': out.x2, 'y': out.y2}, '3': {'x': out.x3, 'y': out.y3}} | tojson }}
  `.trim());

  async function fetchTargets(){
    if(!selectedDevice || liveInFlight || document.visibilityState==='hidden') return;
    liveInFlight=true;
    try{
      const tpl = targetsTemplate(selectedDevice.device_id);
      const res = await api('api/template', { template: tpl }, {retryOnError:false, reloadOnError:false});
      const obj = (typeof res === 'string') ? JSON.parse(res || '{}') : res;
      let changed=false;
      for(const n of [1,2,3]){
        const x = Number(obj?.[String(n)]?.x);
        const y = Number(obj?.[String(n)]?.y);
        if(Number.isFinite(x) && x!==livePos[n].x){ livePos[n].x=x; changed=true; }
        if(Number.isFinite(y) && y!==livePos[n].y){ livePos[n].y=y; changed=true; }
      }
      if(changed) enqueueDraw();
    }catch(_e){ }
    finally{ liveInFlight=false; }
  }

  function findEntityIdBySuffix(suffix){ return (entities.find(x => x.entity_id.endsWith(suffix))?.entity_id)||null; }
  function readNumberBySuffix(suffix){
    const e=entities.find(x=>x.entity_id.endsWith(suffix)); if(!e) return null;
    const v=(typeof e.state==='number')?e.state:Number(e.state);
    return Number.isFinite(v)?v:null;
  }
  async function setNumberBySuffix(suffix, value){
    const id = findEntityIdBySuffix(suffix);
    if(!id) throw new Error(`Entity not found: *${suffix}`);
    await api('api/services/number/set_value', { entity_id: id, value });
    const e = entities.find(x=>x.entity_id===id); if(e) e.state=String(value);
  }

  function zid(z){
    if(z==='excl'){ return { label:'Exclusion Zone', count:'exclusion_zone_points_count', x:(i)=>`exclusion_zone_p${i}_x`, y:(i)=>`exclusion_zone_p${i}_y` }; }
    return { label:`Zone ${z}`, count:`zone_${z}_points_count`, x:(i)=>`zone_${z}_p${i}_x`, y:(i)=>`zone_${z}_p${i}_y` };
  }

  async function loadDeviceEntitiesCore(device_id){
    const rows = await api('api/device_entities', { device_id });
    const arr = Array.isArray(rows) ? rows : JSON.parse(rows||'[]');
    entities = arr.map(e => ({ entity_id:e.entity_id, domain:e.domain, state:e.state, attributes:e.attributes||{} }));
  }

  async function loadDetectionRangeCore(){
    let v = readNumberBySuffix('detection_range_cm'); if(v===null) v=readNumberBySuffix('detection_range');
    detRange = Math.round(Math.max(0,Math.min(MAX_RANGE, v ?? MAX_RANGE)));
    rangeInput.value = String(detRange);
  }

  async function setDetectionRangeCore(){
    let val = Math.round(Number(rangeInput.value));
    if(!Number.isFinite(val)) { setStatus('err','Invalid range'); return; }
    val = Math.max(0,Math.min(MAX_RANGE,val));
    try{
      setStatus('', 'Saving range…');
      try{ await setNumberBySuffix('detection_range_cm', val); } catch{ await setNumberBySuffix('detection_range', val); }
      detRange = val; setStatus('ok', `Range: ${val} cm`); enqueueDraw();
    }catch(e){ setStatus('err', e.message||'Failed to save range'); }
  }

  async function loadZoneCore(z){
    const id=zid(z);
    const n = Math.max(0, Math.min(MAX_POINTS, Math.round(readNumberBySuffix(id.count) || 0)));
    const pts=[];
    for(let i=1;i<=n;i++){
      const x = Math.round(readNumberBySuffix(id.x(i)) ?? 0);
      const y = Math.round(readNumberBySuffix(id.y(i)) ?? 0);
      pts.push({x:clamp(x,X_MIN,X_MAX), y:clamp(y,0,600)});
    }
    zones[z]=pts;
  }

  async function loadAllCore(){
    if(!selectedDevice){ setStatus('err','Select a device'); return; }
    setStatus('', 'Loading…');
    await loadDetectionRangeCore();
    for(const z of ['1','2','3','excl']) await loadZoneCore(z);
    enqueueDraw();
    setStatus('ok','Ready');
  }

  async function saveCurrentZoneCore(){
    if(saving) return;
    if(!selectedDevice){ setStatus('err','No device'); return; }
    const id = zid(currentZone);
    const pts = zones[currentZone]||[];
    const n = Math.min(MAX_POINTS, pts.length);
    try{
      saving=true; saveBtn.disabled=true;
      setStatus('', `Saving ${id.label}…`);
      const tasks=[];
      for(let i=1;i<=MAX_POINTS;i++){
        const p=pts[i-1]||{x:0,y:0};
        tasks.push(setNumberBySuffix(id.x(i), Math.round(clamp(p.x||0,X_MIN,X_MAX))));
        tasks.push(setNumberBySuffix(id.y(i), Math.round(clamp(p.y||0,0,600))));
      }
      await Promise.allSettled(tasks);
      await setNumberBySuffix(id.count, n);
      setStatus('ok', `Saved (${n} point${n===1?'':'s'})`);
      await loadZoneCore(currentZone);
      enqueueDraw();
    }catch(e){ setStatus('err', e.message||'Save failed'); }
    finally{ saving=false; saveBtn.disabled=false; }
  }

  const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
  const cssVar=(name)=>getComputedStyle(document.documentElement).getPropertyValue(name).trim();

  function syncPanelHeight(){
    const twoCols = matchMedia(`(min-width:${SWITCH_BREAKPOINT+1}px)`).matches;
    if(twoCols){
      const h = Math.round(canvasCard.getBoundingClientRect().height);
      panelCard.style.height = h + 'px';
    }else{
      panelCard.style.height = 'auto';
    }
  }

  function resizeCanvas(){
    const cardRect = canvasCard.getBoundingClientRect();
    const worldW = (X_MAX - X_MIN);
    const worldH = 585;

    const pad = 12;
    const maxW = Math.max(320, cardRect.width - pad);
    const maxH = Math.max(260, Math.min(window.innerHeight - 2*pad, (window.innerHeight*0.8)));

    const scale = Math.min(maxW / worldW, maxH / worldH, 1);
    cssW = Math.floor(worldW * scale);
    cssH = Math.floor(worldH * scale);

    if (cvs.style.width !== cssW+'px') cvs.style.width = cssW+'px';
    if (cvs.style.height !== cssH+'px') cvs.style.height = cssH+'px';

    dpr = Math.max(1, window.devicePixelRatio || 1);
    const devW = Math.max(2, Math.round(cssW * dpr)), devH = Math.max(2, Math.round(cssH * dpr));
    if (cvs.width !== devW) cvs.width = devW;
    if (cvs.height !== devH) cvs.height = devH;

    ctx.setTransform(dpr,0,0,dpr,0,0);
  }

  function syncLayout(){
    updateUIScale();
    resizeCanvas();
    enqueueDraw();
    syncPanelHeight();
  }

  const toPxX = (x)=> (x - X_MIN) / (X_MAX-X_MIN) * cssW;
  const toPxY = (y)=> (y - 0) / (600-0) * cssH;
  const toCmX = (px)=> X_MIN + (px / cssW) * (X_MAX-X_MIN);
  const toCmY = (py)=> 0 + (py / cssH) * (600-0);

  function drawGrid(){
    ctx.save();
    ctx.clearRect(0,0,cvs.width/dpr,cvs.height/dpr);
    ctx.lineWidth = 1;
    const gridColor = cssVar('--grid') || '#1e2431';
    const x0 = Math.ceil(X_MIN/GRID)*GRID, y0 = Math.ceil(0/GRID)*GRID;
    for(let x = x0; x <= X_MAX; x += GRID){
      const px = Math.round(toPxX(x)) + 0.5;
      ctx.beginPath();
      ctx.moveTo(px, Math.round(toPxY(0)) + 0.5);
      ctx.lineTo(px, Math.round(toPxY(600)) + 0.5);
      ctx.strokeStyle = gridColor; ctx.globalAlpha = 0.6; ctx.stroke();
    }
    for(let y = y0; y <= 600; y += GRID){
      const py = Math.round(toPxY(y)) + 0.5;
      ctx.beginPath();
      ctx.moveTo(Math.round(toPxX(X_MIN)) + 0.5, py);
      ctx.lineTo(Math.round(toPxX(X_MAX)) + 0.5, py);
      ctx.strokeStyle = gridColor; ctx.globalAlpha = 0.6; ctx.stroke();
    }
    ctx.globalAlpha = 1; ctx.restore();
  }

  function makeFovPoints(range){
    const pts=[], half=FOV_DEG/2, rad=d=>d*Math.PI/180;
    for(let a=half;a>=-half;a-=1.2) pts.push({x:range*Math.sin(rad(a)),y:range*Math.cos(rad(a))});
    pts.push({x:0,y:0},{x:0,y:0});
    return pts;
  }
  function drawFov(range, lighter=false){
    const r = Math.max(0, Math.min(MAX_RANGE, range|0));
    const pts=makeFovPoints(r);
    ctx.beginPath();
    ctx.moveTo(toPxX(pts[0].x),toPxY(pts[0].y));
    for(let i=1;i<pts.length;i++) ctx.lineTo(toPxX(pts[i].x),toPxY(pts[i].y));
    ctx.closePath();
    ctx.globalAlpha = lighter ? 0.08 : 0.15;
    ctx.fillStyle=cssVar('--fov');
    ctx.fill();
    ctx.globalAlpha=1;
  }
  function drawPolygon(pts,style){
    if(pts.length<2) return;
    ctx.beginPath(); ctx.moveTo(toPxX(pts[0].x),toPxY(pts[0].y));
    for(let i=1;i<pts.length;i++) ctx.lineTo(toPxX(pts[i].x),toPxY(pts[i].y));
    if(pts.length>=3) ctx.closePath();
    if(style.fill){ ctx.globalAlpha=style.fillAlpha??1; ctx.fillStyle=style.fill; ctx.fill(); }
    if(style.stroke){ ctx.globalAlpha=1; ctx.lineWidth=style.width??2; ctx.strokeStyle=style.stroke; ctx.stroke(); }
    ctx.globalAlpha=1;
  }
  function zoneStyle(key,active){
    const isExcl=key==='excl';
    if(active){ return isExcl?{fill:cssVar('--z-excl-fill'),stroke:cssVar('--z-excl'),width:2,fillAlpha:1}:{fill:cssVar('--z-norm-fill'),stroke:cssVar('--z-norm'),width:2,fillAlpha:1}; }
    return isExcl?{fill:cssVar('--z-excl-dim-fill'),stroke:cssVar('--z-excl-dim'),width:1.2,fillAlpha:1}:{fill:cssVar('--z-norm-dim-fill'),stroke:cssVar('--z-norm-dim'),width:1.2,fillAlpha:1};
  }

  function targetRadius(){ return matchMedia('(max-width: 768px)').matches ? 5 : 6; }

  function drawHandles(pts){
    const color=currentZone==='excl'?cssVar('--z-excl'):cssVar('--z-norm');
    for(let i=0;i<pts.length;i++){
      const px=toPxX(pts[i].x), py=toPxY(pts[i].y);
      ctx.beginPath(); ctx.arc(px,py,5.5,0,Math.PI*2);
      ctx.fillStyle=i===dragIdx?'#22c55e':color; ctx.fill();
    }
  }
  function drawTargets(){
    const color = cssVar('--pulse') || '#22c55e';
    const r = targetRadius();
    for (const n of [1,2,3]){
      const p = livePos[n];
      if(!p || !Number.isFinite(p.x) || !Number.isFinite(p.y) || (p.x===0&&p.y===0)) continue;
      const px=toPxX(Math.max(-520,Math.min(520,p.x))), py=toPxY(Math.max(0,Math.min(600,p.y)));
      ctx.beginPath(); ctx.arc(px,py,r,0,Math.PI*2); ctx.fillStyle=color; ctx.fill();
    }
  }

  let drawQueued=false;
  function enqueueDraw(){ if(drawQueued) return; drawQueued=true; requestAnimationFrame(()=>{ drawQueued=false; draw(); }); }
  function draw(){
    ctx.clearRect(0,0,cvs.width/dpr,cvs.height/dpr);
    drawGrid();
    drawFov(MAX_RANGE,false);
    if(detRange<MAX_RANGE) drawFov(detRange,true);
    for(const key of ['1','2','3','excl']){ const style=zoneStyle(key,key===currentZone); if(key!==currentZone) drawPolygon(zones[key],style); }
    drawPolygon(zones[currentZone],zoneStyle(currentZone,true));
    drawHandles(zones[currentZone]);
    drawTargets();
  }

  let dragIdx=null, dragWhole=false, lastPX=0, lastPY=0;

  function localPoint(clientX, clientY){
    const r=cvs.getBoundingClientRect(), sx=(cvs.width/dpr)/r.width, sy=(cvs.height/dpr)/r.height;
    return {x:(clientX-r.left)*sx,y:(clientY-r.top)*sy};
  }
  function nearestIdx(px,py){
    const pts=zones[currentZone]; let best=-1,dmin=14;
    for(let i=0;i<pts.length;i++){ const dx=toPxX(pts[i].x)-px, dy=toPxY(pts[i].y)-py, d=Math.hypot(dx,dy); if(d<dmin){ dmin=d; best=i; } }
    return best;
  }
  function pointInPoly(pts, px, py){
    if(!pts || pts.length<3) return false;
    const x=toCmX(px), y=toCmY(py);
    let inside=false;
    for(let i=0,j=pts.length-1;i<pts.length;j=i++){
      const xi=pts[i].x, yi=pts[i].y, xj=pts[j].x, yj=pts[j].y;
      const intersect=((yi>y)!==(yj>y)) && (x < (xj-xi)*(y-yi)/(yj-yi+1e-9) + xi);
      if(intersect) inside=!inside;
    }
    return inside;
  }
  function hitZoneAt(px,py){
    const order=[currentZone, '1','2','3','excl'].filter((v,i,self)=>self.indexOf(v)===i);
    for(const z of order){ const pts=zones[z]; if(pointInPoly(pts,px,py)) return z; }
    return null;
  }
  function setCurrentZone(z){
    currentZone=z;
    zoneBtns.forEach(b=> b.classList.toggle('active', b.dataset.zone===z));
    setStatus('ok', `${z==='excl'?'Exclusion':'Zone '+z} selected`);
  }

  function pointerDown(px,py){
    if(!selectedDevice) return;
    lastPX=px; lastPY=py; dragWhole=false;
    const idx=nearestIdx(px,py), pts=zones[currentZone];
    if(idx>=0){ dragIdx=idx; enqueueDraw(); return; }
    const hit = hitZoneAt(px,py);
    if(hit){
      if(hit!==currentZone){ setCurrentZone(hit); }
      dragWhole=true; dragIdx=null; return;
    }
    if(pts.length>=MAX_POINTS) return;
    const x=Math.round(toCmX(px)), y=Math.round(toCmY(py));
    pts.push({x:Math.max(X_MIN,Math.min(X_MAX,x)),y:Math.max(0,Math.min(600,y))}); enqueueDraw();
  }
  function pointerMove(px,py){
    if(dragIdx==null && !dragWhole) return;
    if(dragWhole){
      const dx = toCmX(px)-toCmX(lastPX);
      const dy = toCmY(py)-toCmY(lastPY);
      const pts = zones[currentZone];
      let canMove=true;
      for(const p of pts){
        const nx=Math.max(X_MIN,Math.min(X_MAX,p.x+dx));
        const ny=Math.max(0,Math.min(600,p.y+dy));
        if(nx!==p.x+dx || ny!==p.y+dy){ canMove=false; break; }
      }
      if(canMove){
        for(let i=0;i<pts.length;i++){ pts[i]={x:pts[i].x+dx, y:pts[i].y+dy}; }
        lastPX=px; lastPY=py; enqueueDraw();
      }
      return;
    }
    const pts=zones[currentZone];
    pts[dragIdx]={x:Math.round(Math.max(X_MIN,Math.min(X_MAX, toCmX(px)))),
                  y:Math.round(Math.max(0,Math.min(600, toCmY(py))))}; enqueueDraw();
  }
  function pointerUp(){ dragIdx=null; dragWhole=false; }

  const loadDeviceEntities = pauseDuring(async (device_id)=>{
    const rows = await api('api/device_entities', { device_id });
    const arr = Array.isArray(rows) ? rows : JSON.parse(rows||'[]');
    entities = arr.map(e => ({ entity_id:e.entity_id, domain:e.domain, state:e.state, attributes:e.attributes||{} }));
  });
  const loadDetectionRange = pauseDuring(loadDetectionRangeCore);
  const setDetectionRange = pauseDuring(setDetectionRangeCore);
  const loadZone = pauseDuring(loadZoneCore);
  const loadAll = pauseDuring(loadAllCore);
  const saveCurrentZone = pauseDuring(saveCurrentZoneCore);

  cvs.addEventListener('mousedown',e=>{ const p=localPoint(e.clientX,e.clientY); pointerDown(p.x,p.y); });
  window.addEventListener('mousemove',e=>{ const p=localPoint(e.clientX,e.clientY); pointerMove(p.x,p.y); });
  window.addEventListener('mouseup',pointerUp);

  cvs.addEventListener('touchstart',e=>{ const t=e.touches[0]; if(!t) return; const p=localPoint(t.clientX,t.clientY); pointerDown(p.x,p.y); e.preventDefault(); }, {passive:false});
  cvs.addEventListener('touchmove',e=>{ const t=e.touches[0]; if(!t) return; const p=localPoint(t.clientX,t.clientY); pointerMove(p.x,p.y); e.preventDefault(); }, {passive:false});
  cvs.addEventListener('touchend',()=>pointerUp(), {passive:true});
  cvs.addEventListener('touchcancel',()=>pointerUp(), {passive:true});

  zoneBtns.forEach(btn=>{
    btn.addEventListener('click', pauseDuring(async ()=>{
      setCurrentZone(btn.dataset.zone);
      if(selectedDevice){ await loadZoneCore(currentZone); enqueueDraw(); }
    }));
  });
  clearBtn.addEventListener('click', pauseDuring(async ()=>{ zones[currentZone]=[]; enqueueDraw(); setStatus('', 'Cleared'); }));
  saveBtn.addEventListener('click', saveCurrentZone);
  rangeSetBtn.addEventListener('click', setDetectionRange);
  rangeInput.addEventListener('keydown', e=>{ if(e.key==='Enter') setDetectionRange(); });

  (async ()=>{
    try{
      pauseLive();
      await api('api/template', { template: '{{ 1+1 }}' });
      const res = await api('api/template', { template: TPL_LIST });
      const list = typeof res === 'string' ? JSON.parse(res||'[]') : res;

      sel.innerHTML = '';
      list.sort((a,b)=> (a.name||a.device_id).localeCompare(b.name||b.device_id))
        .forEach((d,i)=>{
          const opt = document.createElement('option');
          opt.value = d.device_id;
          opt.textContent = d.name || d.device_id;
          opt.dataset.model = d.model || '';
          if(i===0) opt.selected = true;
          sel.appendChild(opt);
        });

      if(!list.length){ setStatus('err','No devices found'); return; }
      selectedDevice = {
        device_id: sel.value,
        name: sel.options[sel.selectedIndex]?.textContent || sel.value,
        model: sel.options[sel.selectedIndex]?.dataset.model || ''
      };
      setStatus('', 'Loading device…');
      await loadDeviceEntities(selectedDevice.device_id);
      await loadAll();
      setStatus('ok','Ready');
    }catch(e){ setStatus('err','API error: '+(e.message||e)); }
    finally{
      syncLayout();
      new ResizeObserver(()=>{ syncLayout(); }).observe(container);
      window.addEventListener('resize', syncLayout);
      document.addEventListener('visibilitychange',()=>{ if(document.visibilityState==='hidden') pauseLive(); else resumeLive(); });
      resumeLive();
    }
  })();

  sel.addEventListener('change', pauseDuring(async ()=>{
    if(!sel.value){ setStatus('err','No device selected'); return; }
    selectedDevice = {
      device_id: sel.value,
      name: sel.options[sel.selectedIndex]?.textContent || sel.value,
      model: sel.options[sel.selectedIndex]?.dataset.model || ''
    };
    try{
      setStatus('', 'Loading device…');
      await loadDeviceEntities(selectedDevice.device_id);
      await loadAll();
      setStatus('ok','Ready');
    }catch(e){
      setStatus('err','Load failed: '+(e.message||e));
    }finally{
      syncLayout();
    }
  }));

})();
</script>
</body>
</html>