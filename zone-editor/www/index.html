<!doctype html>
<html lang="en">
<head> 
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sensy-One Zone Editor</title>
<style> 
  :root{
    --ui: 1;
    --bg:#06070a; --panel:#0a0c11; --panel-2:#0b0d12; --ctrl:#10131a; --bd:#171b22;
    --fg:#e6eaf1; --muted:#9aa3ad; --ok:#22c55e; --err:#ef4444;
    --canvas:#0a0d12; --fov:#5f7cff;
    --z-norm:#69b1ff; --z-norm-fill:rgba(105,177,255,.16); --z-norm-dim:#3c6fa9; --z-norm-dim-fill:rgba(105,177,255,.08);
    --z-excl:#ff6b6b; --z-excl-fill:rgba(255,107,107,.16); --z-excl-dim:#a84848; --z-excl-dim-fill:rgba(255,107,107,.08);
    --pulse:#22c55e; --grid:#1e2431;
    --pad0: 10px; --gap0: 10px; --btnh0: 36px; --radius0: 12px;
    --fs0: 14px; --title0: 14px; --small0: 12px;
    --pad: calc(var(--pad0) * var(--ui));
    --gap: calc(var(--gap0) * var(--ui));
    --btnh: calc(var(--btnh0) * var(--ui));
    --radius: calc(var(--radius0) * var(--ui));
    --fs: calc(var(--fs0) * var(--ui));
    --title: calc(var(--title0) * var(--ui));
    --small: calc(var(--small0) * var(--ui));
    --base-canvas-w: 1200px;
    --base-canvas-h: 720px;
    --base-panel-w: 400px;
    --canvas-w: calc(var(--base-canvas-w) * var(--ui));
    --panel-w:  calc(var(--base-panel-w)  * var(--ui));
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font:var(--fs)/1.4 system-ui,Segoe UI,Roboto,Arial}
  .container{width:100%;min-height:100vh;margin:0 auto;padding:var(--pad);display:grid;gap:var(--gap);
    grid-template-columns:minmax(0,var(--canvas-w)) var(--panel-w);align-items:start;max-width:calc(var(--canvas-w) + var(--panel-w) + var(--gap));}
  @media (max-width:1150px){.container{grid-template-columns:1fr;gap:calc(var(--gap0)*0.6);max-width:100%;}}
  .card{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid var(--bd);border-radius:var(--radius);min-width:0;}
  .canvas-wrap{padding:calc(6px * var(--ui)); position:relative;}
  #canvas{display:block;width:var(--canvas-w);height:calc(var(--base-canvas-h) * var(--ui));max-width:100%;height:auto;aspect-ratio:1200/720;
    border-radius:calc(10px * var(--ui));touch-action:none;background:var(--canvas);}

  .legend,
  .view-toggle{
    display:flex;
    align-items:center;
    gap:8px;
    background:#0b0f17cc;
    border:1px solid #1a2030;
    border-radius:10px;
    padding:6px 10px;
    min-height:var(--btnh);
  }
  .view-toggle{
    position:absolute;
    right:12px;
    top:12px;
    z-index:5;
  }

  .view-toggle-btn{
    border:none;
    background:transparent;
    color:#b9c2cf;
    font-size:12px;
    min-width:var(--btnh);
    height:var(--btnh);
    padding:0 6px;
    line-height:1;
    display:flex;
    align-items:center;
    justify-content:center;
    border-radius:6px;
    cursor:pointer;
  }
  .legend-btn{
    padding:0;
    min-width:var(--btnh);
  }
  .view-toggle-btn.active{
    background:#151b28;
    color:#e6eaf1;
  }

  .legend{
    position:absolute;
    right:12px;
    bottom:12px;
  }
  .legend-bar{
    width:120px;
    height:8px;
    border-radius:999px;
    background:linear-gradient(90deg,#0d2038,#2a7bff,#41ffd4,#a6ff63,#ffe066,#ff9a5c,#ff6b6b);
  }
  @media (max-width:700px){
  .legend,
  .view-toggle{
    padding:2px 6px;
    gap:4px;
    min-height:calc(34px * var(--ui));
    right:8px;
  }

  .view-toggle{
    top:8px;
  }

  .legend{
    bottom:8px;
  }

  .view-toggle-btn{
    min-width:calc(34px * var(--ui));
    height:calc(34px * var(--ui));
    padding:0 8px;
    font-size:12px;
    border-radius:6px;
  }

  .legend-btn{
    min-width:calc(34px * var(--ui));
    height:calc(34px * var(--ui));
    padding:0;
  }

  .legend-bar{
    width:80px;
    height:6px;
  }
}

.card,
.canvas-wrap,
.legend,
.view-toggle {
  background: #0a0c11 !important;
  forced-color-adjust: none;
  backdrop-filter: none !important;
  opacity: 1 !important;
}

* {
  forced-color-adjust: none;
}

  .panel{padding:var(--pad);display:flex;flex-direction:column;gap:var(--gap);overflow:auto;}
  .section{background:var(--ctrl);border:1px solid var(--bd);border-radius:calc(10px * var(--ui));padding:calc(10px * var(--ui));display:flex;flex-direction:column;gap:calc(4px * var(--ui));min-width:0;}
  .row{display:flex;gap:calc(6px * var(--ui));align-items:center;flex-wrap:nowrap}
  .row.equal>*{flex:1 1 0;min-width:0}
  input,button,select{height:var(--btnh);border-radius:calc(9px * var(--ui));border:1px solid #1a1f2a;background:#121620;color:var(--fg);padding:0 calc(10px * var(--ui));font:inherit;outline:none;min-width:0;max-width:100%;}
  input.readonly{pointer-events:none}
  button{cursor:pointer;transition:transform .04s,background-color .15s,border-color .15s;white-space:nowrap;text-align:center}
  .btn-primary{background:#151b28;border-color:#202638}.btn-primary:hover{background:#192132;border-color:#2a3550}.btn-primary:active{transform:translateY(1px)}
  .btn-plain{background:#121620;border-color:#1a1f2a}.btn-plain:hover{background:#151a24;border-color:#212836}
  select{cursor:pointer;appearance:none;-webkit-appearance:none;-moz-appearance:none;background-image:url("data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 10l5 5 5-5' stroke='%23cfd6e2' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right calc(8px * var(--ui)) center;padding-right:calc(26px * var(--ui));}
  input[type=number]::-webkit-outer-spin-button,input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
  input[type=number]{-moz-appearance:textfield;appearance:textfield}
  .title{font-size:var(--title);font-weight:600;color:#cfd6e2}
  .dot{width:calc(10px * var(--ui));height:calc(10px * var(--ui));border-radius:50%;background:#343a46;flex:0 0 auto}
  .dot.ok{background:var(--ok)} .dot.err{background:var(--err)}
  .input-with-icon{position:relative;width:100%;}
  .status-icon{position:absolute;left:calc(10px * var(--ui));top:50%;transform:translateY(-50%);pointer-events:none;}
  .status-input{width:100%;padding-left:calc(10px * var(--ui) + 12px * var(--ui) + 8px);}
  .zones{display:grid;grid-template-columns:1fr;gap:calc(6px * var(--ui))}
  .zone-btn{height:calc(34px * var(--ui));font-size:calc(13px * var(--ui))}
  .zone-btn.active{background:#151e2c;border-color:#2a3550}
  .row.equal .btn-primary,.row.equal .btn-plain{min-width:calc(96px * var(--ui))}
  @media (max-width:1150px){
    :root{--btnh0:34px}
    .canvas-wrap{padding:calc(4px * var(--ui))}
    .panel{padding:calc(6px * var(--ui));gap:calc(6px * var(--ui))}
    .zones{gap:calc(6px * var(--ui))}
  }
</style>
</head>
<body style="opacity:0;">
  <div class="container" id="container">
    <div id="canvasCard" class="card canvas-wrap">
      <canvas id="canvas"></canvas>

      <div class="view-toggle" id="viewToggle">
        <button class="view-toggle-btn active" data-view="2d">2D</button>
        <button class="view-toggle-btn" data-view="3d">3D</button>
      </div>

      <div class="legend" id="legend">
        <button class="view-toggle-btn legend-btn" data-op="minus">−</button>
        <div class="legend-bar"></div>
        <button class="view-toggle-btn legend-btn" data-op="plus">+</button>
      </div>
    </div>
    <div id="panelCard" class="card panel">
      <div class="section">
        <div class="title">Device</div>
        <div class="row"><select id="selDevices" aria-label="Device list" style="flex:1"></select></div>
      </div>
      <div class="section">
        <div class="title">Status</div>
        <div class="row">
          <div class="input-with-icon">
            <span id="sDot" class="dot status-icon" aria-hidden="true"></span>
            <input id="sText" class="status-input readonly" value="Searching…" readonly />
          </div>
        </div>
      </div>
      <div class="section">
        <div class="title">View Mode</div>
        <div class="row equal">
          <button id="liveModeBtn" class="btn-primary">Live Targets</button>
          <select id="heatmapHoursSel" aria-label="Heatmap hours">
            <option value="1">1h</option><option value="3">3h</option><option value="6">6h</option>
            <option value="12">12h</option><option value="24" selected>24h</option>
          </select>
          <button id="heatmapModeBtn" class="btn-plain">Heatmap</button>
        </div>
      </div>
      <div class="section">
        <div class="title">Detection range</div>
        <div class="row equal">
          <input id="rangeInput" type="number" min="0" max="600" step="1" placeholder="0 – 600 cm" inputmode="numeric" />
          <button id="rangeSetBtn" class="btn-primary">Save</button>
        </div>
      </div>
      <div class="section">
        <div class="title">Zones</div>
        <div class="zones">
          <button class="zone-btn btn-plain" data-zone="1">Zone 1</button>
          <button class="zone-btn btn-plain" data-zone="2">Zone 2</button>
          <button class="zone-btn btn-plain" data-zone="3">Zone 3</button>
          <button class="zone-btn btn-plain" data-zone="excl">Exclusion Zone</button>
        </div>
      </div>
      <div class="section">
        <div class="title">Actions</div>
        <div class="row equal">
          <button id="saveBtn" class="btn-primary">Save</button>
          <button id="clearBtn" class="btn-plain">Clear</button>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const BASE_CANVAS_W=1200, BASE_PANEL_W=400, BASE_GAP=10, SWITCH_BREAKPOINT=1150;
  const $=id=>document.getElementById(id);
  const container=$('container'), canvasCard=$('canvasCard'), panelCard=$('panelCard');
  const cvs=$('canvas'), ctx=cvs.getContext('2d',{alpha:true,desynchronized:true});
  const sel=$('selDevices');
  const saveBtn=$('saveBtn'), clearBtn=$('clearBtn');
  const rangeInput=$('rangeInput'), rangeSetBtn=$('rangeSetBtn');
  const liveModeBtn=$('liveModeBtn'),
        heatmapModeBtn=$('heatmapModeBtn'),
        heatmapHoursSel=$('heatmapHoursSel');
  const sDot=$('sDot'), sText=$('sText');
  const zoneBtns=[...document.querySelectorAll('.zone-btn')];
  const legend=$('legend');
  const viewToggle=$('viewToggle');
  const viewToggleBtns=[...document.querySelectorAll('.view-toggle-btn[data-view]')];
  const legendSigmaBtns=[...document.querySelectorAll('.legend-btn')];

  const X_MIN=-525, X_MAX=525, Y_MIN=0, Y_MAX=600;
  const WORLD_W = X_MAX - X_MIN;
  const WORLD_H = Y_MAX - Y_MIN;
  const MAX_RANGE=600, MAX_POINTS=8, FOV_DEG=120, GRID=100;
  const FOV_RAD = FOV_DEG * Math.PI / 180;

  const WALL_HEIGHT_CM = 180;
  const HEATMAP_MAX_HEIGHT_CM = 150;
  const HEATMAP3D_MAX_RES = 1024;

  const TUNE = {
    sigmaScale: 1.0,
    clipPercentile: 0.99,
    gamma: 0.5,
    minCutoff: 0.08,
    maxAlpha: 250,
    pointWeight: 0.5
  };

  let cssW=0, cssH=0, dpr=1, PAD=12;
  let currentZone=null;
  const zones={'1':[],'2':[],'3':[],'excl':[]};
  const livePos = {
    1: { x: NaN, y: NaN, px: NaN, py: NaN, heading: 0 },
    2: { x: NaN, y: NaN, px: NaN, py: NaN, heading: 0 },
    3: { x: NaN, y: NaN, px: NaN, py: NaN, heading: 0 }
  };
  let selectedDevice=null, entities=[], detRange=MAX_RANGE, saving=false;
  let viewMode='live';
  let viewDim='2d';
  let heatmapPositions=[];
  let heatmapFieldColor=null, heatmapFieldHeight=null, heatmapFieldW=0, heatmapFieldH=0;

  const DEFAULT_AZIMUTH = 0;
  const DEFAULT_ELEVATION = Math.PI * 0.5;
  const DEFAULT_DISTANCE_FACTOR = 0.86;

  const ORBIT = {
    azimuth: DEFAULT_AZIMUTH,
    elevation: DEFAULT_ELEVATION,
    distance: 1400
  };
  const ORBIT_LIMITS = {
    minElev: -Math.PI * 0.05,
    maxElev: Math.PI * 0.9,
    minDist: 250,
    maxDist: 750
  };

  function resetOrbitForHeatmap(){
    const r = MAX_RANGE;
    ORBIT.azimuth   = DEFAULT_AZIMUTH;
    ORBIT.elevation = DEFAULT_ELEVATION;
    ORBIT.distance  = clamp(r * DEFAULT_DISTANCE_FACTOR, ORBIT_LIMITS.minDist, ORBIT_LIMITS.maxDist);
  }

  let orbitDragging=false, orbitLastX=0, orbitLastY=0;
  let pinchZooming=false, pinchLastDist=0;

  const cam3D = {
    pos:{x:0,y:0,z:0},
    target:{x:0,y:0,z:0},
    cosA:0,sinA:0,cosE:0,sinE:0,
    scale:1,
    cx:0,cy:0,
    near:0.5,
    fovDeg:60,
    aspect:1
  };

  const BOOT_KEY='sensy_boot_reloaded_once';
  let liveTimer=null, livePauseDepth=0, liveInFlight=false;
  const LIVE_INTERVAL_MS=30;

  const cssVar=(n)=>getComputedStyle(document.documentElement).getPropertyValue(n).trim();
  const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));

  function smoothstep01(t){
    t = clamp(t,0,1);
    return t*t*(3-2*t);
  }

  function updateUIScale(){
    const isTwoCols=window.matchMedia('(min-width:1151px)').matches;
    if(!isTwoCols) document.documentElement.style.setProperty('--ui','1');
    else{
      const vw=Math.max(320,window.innerWidth), gutter=32;
      const available=vw-gutter, baseTotal=BASE_CANVAS_W+BASE_PANEL_W+BASE_GAP;
      const scale=Math.max(0.6,Math.min(1,available/baseTotal));
      document.documentElement.style.setProperty('--ui',String(scale));
    }
    const ui=parseFloat(cssVar('--ui')||'1')||1; PAD=Math.round(14*ui);
  }

  function stopLive(){
    if(liveTimer){
      clearInterval(liveTimer);
      liveTimer=null;
    }
  }

  function pauseLive(){
    livePauseDepth++;
    stopLive();
  }

  function resumeLive(force=false){
    if(force){
      livePauseDepth = 0;
    }else{
      livePauseDepth = Math.max(0, livePauseDepth - 1);
    }
    if(livePauseDepth===0 && selectedDevice && !liveTimer){
      liveTimer = setInterval(fetchTargets, LIVE_INTERVAL_MS);
    }
  }

  const pauseDuring=(fn)=>async(...a)=>{ pauseLive(); try{ return await fn(...a); } finally{ resumeLive(); } };

  function setStatus(kind,msg){
    sDot.className='dot status-icon'+(kind?(' '+kind):'');
    sText.value=msg;
  }

  async function api(path, body, {retryOnError=true, reloadOnError=true}={}){
    try{
      const r=await fetch(path,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'include',
        body:JSON.stringify(body||{})
      });
      const text=await r.text();
      if(!r.ok){
        if((r.status===500||r.status===502)&&retryOnError){
          await new Promise(res=>setTimeout(res,200));
          return api(path,body,{retryOnError:false,reloadOnError});
        }
        if((r.status===500||r.status===502)&&reloadOnError&&!localStorage.getItem(BOOT_KEY)){
          localStorage.setItem(BOOT_KEY,'1');
          location.reload();
          await new Promise(()=>{});
        }
        let msg=r.status+' '+r.statusText;
        try{
          const j=JSON.parse(text);
          msg=(j.error||msg)+(j.details?` (${j.details})`:'');
        }catch{}
        throw new Error(msg);
      }
      localStorage.removeItem(BOOT_KEY);
      const ct=r.headers.get('content-type')||'';
      return ct.includes('application/json')?JSON.parse(text):text;
      }catch(err){
      if(reloadOnError && err instanceof TypeError && !localStorage.getItem(BOOT_KEY)){
        localStorage.setItem(BOOT_KEY,'1');
        location.reload();
        await new Promise(()=>{});
      }
      throw err;
    }
  }

  const TPL_LIST=`
{% set out = namespace(items=[], ids=[]) %}
{% for s in states %}
  {% set dev = s.entity_id | device_id %}
  {% if dev and (device_attr(dev,'manufacturer') or '') == 'Sensy-One' and (dev not in out.ids) %}
    {% set name = device_attr(dev,'name_by_user') or device_attr(dev,'name') or dev %}
    {% set model = device_attr(dev,'model') or '' %}
    {% set out.items = out.items + [ { 'device_id': dev, 'name': name, 'model': model } ] %}
    {% set out.ids = out.ids + [ dev ] %}
  {% endif %}
{% endfor %}
{{ out.items | tojson }}
  `.trim();

  const targetsTemplate=(devId)=>(`
{% set dev = '`+devId+`' %}
{% set out = namespace(
  x1=0.0,y1=0.0,a1=0.0,
  x2=0.0,y2=0.0,a2=0.0,
  x3=0.0,y3=0.0,a3=0.0
) %}
{% for s in states if (s.entity_id | device_id) == dev %}
  {% set id = s.entity_id %}
  {% if id.endswith('target_1_x') %}{% set out.x1 = (s.state | float(0)) %}{% endif %}
  {% if id.endswith('target_1_y') %}{% set out.y1 = (s.state | float(0)) %}{% endif %}
  {% if id.endswith('target_1_angle') %}{% set out.a1 = (s.state | float(0)) %}{% endif %}

  {% if id.endswith('target_2_x') %}{% set out.x2 = (s.state | float(0)) %}{% endif %}
  {% if id.endswith('target_2_y') %}{% set out.y2 = (s.state | float(0)) %}{% endif %}
  {% if id.endswith('target_2_angle') %}{% set out.a2 = (s.state | float(0)) %}{% endif %}

  {% if id.endswith('target_3_x') %}{% set out.x3 = (s.state | float(0)) %}{% endif %}
  {% if id.endswith('target_3_y') %}{% set out.y3 = (s.state | float(0)) %}{% endif %}
  {% if id.endswith('target_3_angle') %}{% set out.a3 = (s.state | float(0)) %}{% endif %}
{% endfor %}
{{ {
  '1': {'x': out.x1, 'y': out.y1, 'angle': out.a1},
  '2': {'x': out.x2, 'y': out.y2, 'angle': out.a2},
  '3': {'x': out.x3, 'y': out.y3, 'angle': out.a3}
} | tojson }}
`.trim());


  async function fetchTargets(){
    if(!selectedDevice || liveInFlight || document.visibilityState==='hidden') return;
    liveInFlight=true;
    try{
      const tpl=targetsTemplate(selectedDevice.device_id);
      const res=await api('api/template',{template:tpl},{retryOnError:false,reloadOnError:false});
      const obj=(typeof res==='string')?JSON.parse(res||'{}'):res;
      let changed=false;
      for (const n of [1, 2, 3]) {
        const item = obj?.[String(n)] || {};
        const x = Number(item.x);
        const y = Number(item.y);

        const lp = livePos[n];
        const prevX = lp.x;
        const prevY = lp.y;

        if (Number.isFinite(x) && x !== lp.x) {
          lp.x = x;
          changed = true;
        }
        if (Number.isFinite(y) && y !== lp.y) {
          lp.y = y;
          changed = true;
        }

        if (
          Number.isFinite(prevX) && Number.isFinite(prevY) &&
          Number.isFinite(lp.x) && Number.isFinite(lp.y)
        ) {
          const dx = lp.x - prevX;
          const dz = lp.y - prevY;

          const dist2 = dx * dx + dz * dz;
          if (dist2 > 5) {
            lp.heading = Math.atan2(dx, dz);
          }
        }

        lp.px = prevX;
        lp.py = prevY;
      }
      if(changed) enqueueDraw();
    }catch(_e){} finally{ liveInFlight=false; }
  }

  function findEntityIdBySuffix(suffix){
    return (entities.find(x=>x.entity_id.endsWith(suffix))?.entity_id)||null;
  }
  function readNumberBySuffix(suffix){
    const e=entities.find(x=>x.entity_id.endsWith(suffix));
    if(!e) return null;
    const v=(typeof e.state==='number')?e.state:Number(e.state);
    return Number.isFinite(v)?v:null;
  }
  async function setNumberBySuffix(suffix,value){
    const id=findEntityIdBySuffix(suffix);
    if(!id) throw new Error('Entity not found: *'+suffix);
    await api('api/services/number/set_value',{entity_id:id,value});
    const e=entities.find(x=>x.entity_id===id);
    if(e) e.state=String(value);
  }

  function zid(z){
    if(z==='excl'){
      return {
        label:'Exclusion Zone',
        count:'exclusion_zone_points_count',
        x:(i)=>`exclusion_zone_p${i}_x`,
        y:(i)=>`exclusion_zone_p${i}_y`
      };
    }
    return {
      label:`Zone ${z}`,
      count:`zone_${z}_points_count`,
      x:(i)=>`zone_${z}_p${i}_x`,
      y:(i)=>`zone_${z}_p${i}_y`
    };
    
  }
    async function loadDeviceEntitiesCore(device_id){
    const rows=await api('api/device_entities',{device_id},{reloadOnError:false});
    const arr=Array.isArray(rows)?rows:JSON.parse(rows||'[]');
    entities=arr.map(e=>({entity_id:e.entity_id,domain:e.domain,state:e.state,attributes:e.attributes||{}}));
  }

  async function loadDetectionRangeCore(){
    let v=readNumberBySuffix('detection_range_cm');
    if(v===null) v=readNumberBySuffix('detection_range');
    detRange=Math.round(Math.max(Y_MIN,Math.min(MAX_RANGE,v??MAX_RANGE)));
    rangeInput.value=String(detRange);
  }

  async function setDetectionRangeCore(){
    let val=Math.round(Number(rangeInput.value));
    if(!Number.isFinite(val)){
      setStatus('err','Invalid range');
      return;
    }
    val=Math.max(Y_MIN,Math.min(MAX_RANGE,val));
    try{
      setStatus('','Saving range…');
      try{
        await setNumberBySuffix('detection_range_cm',val);
      }catch{
        await setNumberBySuffix('detection_range',val);
      }
      detRange=val;
      setStatus('ok','Range: '+val+' cm');
      enqueueDraw();
    }catch(e){
      setStatus('err',e.message||'Failed to save range');
    }
  }

  async function loadZoneCore(z){
    const id=zid(z);
    const n=Math.max(0,Math.min(MAX_POINTS,Math.round(readNumberBySuffix(id.count)||0)));
    const pts=[];
    for(let i=1;i<=n;i++){
      const x=Math.round(readNumberBySuffix(id.x(i))??0);
      const y=Math.round(readNumberBySuffix(id.y(i))??0);
      pts.push({x:clamp(x,X_MIN,X_MAX), y:clamp(y,Y_MIN,Y_MAX)});
    }
    zones[z]=pts;
  }

  async function loadAllCore(){
    if(!selectedDevice){
      setStatus('err','Select a device');
      return;
    }
    setStatus('','Loading…');
    await loadDetectionRangeCore();
    for(const z of ['1','2','3','excl']) await loadZoneCore(z);
    enqueueDraw();
    setStatus('ok','Ready');
  }

  async function saveCurrentZoneCore(){
    if(saving) return;
    if(!selectedDevice){
      setStatus('err','No device');
      return;
    }
    if(!currentZone){
      setStatus('err','Select a zone first');
      return;
    }
    const id=zid(currentZone);
    const pts=zones[currentZone]||[];
    const n=Math.min(MAX_POINTS,pts.length);
    try{
      saving=true;
      saveBtn.disabled=true;
      setStatus('','Saving '+id.label+'…');
      const tasks=[];
      for(let i=1;i<=MAX_POINTS;i++){
        const p=pts[i-1]||{x:0,y:0};
        tasks.push(setNumberBySuffix(id.x(i),Math.round(clamp(p.x||0,X_MIN,X_MAX))));
        tasks.push(setNumberBySuffix(id.y(i),Math.round(clamp(p.y||0,Y_MIN,Y_MAX))));
      }
      await Promise.allSettled(tasks);
      await setNumberBySuffix(id.count,n);
      setStatus('ok',`Saved (${n} point${n===1?'':'s'})`);
      await loadZoneCore(currentZone);
      enqueueDraw();
    }catch(e){
      setStatus('err',e.message||'Save failed');
    }finally{
      saving=false;
      saveBtn.disabled=false;
    }
  }

  function parsePx(v){ return Number((v||'0').toString().replace('px',''))||0; }
  function getCardPaddings(el){
    const cs=getComputedStyle(el);
    return {
      pt:parsePx(cs.paddingTop),
      pb:parsePx(cs.paddingBottom),
      pl:parsePx(cs.paddingLeft),
      pr:parsePx(cs.paddingRight)
    };
  }

  function resizeCanvas(){
    const twoCols=matchMedia(`(min-width:${SWITCH_BREAKPOINT+1}px)`).matches;
    const cardRect=canvasCard.getBoundingClientRect();
    const pad=getCardPaddings(canvasCard);
    if(twoCols){
      const panelH=Math.max(200,Math.round(panelCard.getBoundingClientRect().height));
      const targetCssH=Math.max(2,panelH-(pad.pt+pad.pb));
      let targetCssW=Math.round(targetCssH*(WORLD_W/WORLD_H));
      const maxCssW=Math.max(200,Math.round(cardRect.width-(pad.pl+pad.pr)));
      if(targetCssW>maxCssW){
        targetCssW=maxCssW;
        const cappedCssH=Math.round(targetCssW*(WORLD_H/WORLD_W));
        cssW=targetCssW;
        cssH=cappedCssH;
      }else{
        cssW=targetCssW;
        cssH=targetCssH;
      }
    }else{
      const maxCssW=Math.max(200,Math.round(cardRect.width-(pad.pl+pad.pr)));
      cssW=maxCssW;
      cssH=Math.round(cssW*(WORLD_H/WORLD_W));
    }
    const styleW=cssW+'px', styleH=cssH+'px';
    if(cvs.style.width!==styleW) cvs.style.width=styleW;
    if(cvs.style.height!==styleH) cvs.style.height=styleH;
    dpr=Math.max(1,window.devicePixelRatio||1);
    const devW=Math.max(2,Math.round(cssW*dpr)), devH=Math.max(2,Math.round(cssH*dpr));
    if(cvs.width!==devW) cvs.width=devW;
    if(cvs.height!==devH) cvs.height=devH;
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }

  function syncLayout(){
    updateUIScale();
    resizeCanvas();
    heatmapFieldColor=null;
    heatmapFieldHeight=null;
    enqueueDraw();
  }

  function innerW(){ return Math.max(2,cssW-2*PAD); }
  function innerH(){ return Math.max(2,cssH-2*PAD); }
  const toPxX=(x)=> PAD+(x-X_MIN)/WORLD_W*innerW();
  const toPxY=(y)=> PAD+(y-Y_MIN)/WORLD_H*innerH();
  const toCmX=(px)=> X_MIN+((px-PAD)/innerW())*WORLD_W;
  const toCmY=(py)=> Y_MIN+((py-PAD)/innerH())*WORLD_H;

  function drawGrid(){
    ctx.save();
    ctx.clearRect(0,0,cvs.width/dpr,cvs.height/dpr);
    ctx.lineWidth=1;
    const gridColor=cssVar('--grid')||'#1e2431';
    ctx.strokeStyle=gridColor;
    ctx.globalAlpha=0.6;

    const x0=Math.ceil(X_MIN/GRID)*GRID, y0=Math.ceil(Y_MIN/GRID)*GRID;
    for(let x=x0;x<=X_MAX;x+=GRID){
      const px=Math.round(toPxX(x))+0.5;
      ctx.beginPath();
      ctx.moveTo(px,Math.round(toPxY(Y_MIN))+0.5);
      ctx.lineTo(px,Math.round(toPxY(Y_MAX))+0.5);
      ctx.stroke();
    }
    for(let y=y0;y<=Y_MAX;y+=GRID){
      const py=Math.round(toPxY(y))+0.5;
      ctx.beginPath();
      ctx.moveTo(Math.round(toPxX(X_MIN))+0.5,py);
      ctx.lineTo(Math.round(toPxX(X_MAX))+0.5,py);
      ctx.stroke();
    }
    ctx.globalAlpha=1;
    ctx.restore();
  }

  function makeFovPoints(range){
    const pts=[];
    const half=FOV_DEG/2;
    const rad=Math.PI/180;
    pts.push({x:0,y:0});
    for(let a=-half;a<=half;a+=1){
      const x=range*Math.sin(a*rad);
      const y=range*Math.cos(a*rad);
      pts.push({x,y});
    }
    pts.push({x:0,y:0});
    return pts;
  }

  function drawFov(range,lighter=false){
    const r=Math.max(0,Math.min(MAX_RANGE,range|0));
    const pts=makeFovPoints(r);
    ctx.beginPath();
    ctx.moveTo(toPxX(pts[0].x),toPxY(pts[0].y));
    for(let i=1;i<pts.length;i++) ctx.lineTo(toPxX(pts[i].x),toPxY(pts[i].y));
    ctx.closePath();
    ctx.globalAlpha=lighter?0.10:0.18;
    ctx.fillStyle=cssVar('--fov');
    ctx.fill();
    ctx.globalAlpha=1;
  }

  function drawPolygon(pts,style){
    if(!pts || pts.length<2) return;
    ctx.beginPath();
    ctx.moveTo(toPxX(pts[0].x),toPxY(pts[0].y));
    for(let i=1;i<pts.length;i++) ctx.lineTo(toPxX(pts[i].x),toPxY(pts[i].y));
    if(pts.length>=3) ctx.closePath();
    if(style.fill){
      ctx.globalAlpha=style.fillAlpha??1;
      ctx.fillStyle=style.fill;
      ctx.fill();
    }
    if(style.stroke){
      ctx.globalAlpha=1;
      ctx.lineWidth=style.width??2;
      ctx.strokeStyle=style.stroke;
      ctx.stroke();
    }
    ctx.globalAlpha=1;
  }

  function zoneStyle(key,active){
    const isExcl=key==='excl';
    if(active){
      return isExcl
        ? {fill:cssVar('--z-excl-fill'),stroke:cssVar('--z-excl'),width:2,fillAlpha:1}
        : {fill:cssVar('--z-norm-fill'),stroke:cssVar('--z-norm'),width:2,fillAlpha:1};
    }
    return isExcl
      ? {fill:cssVar('--z-excl-dim-fill'),stroke:cssVar('--z-excl-dim'),width:1.2,fillAlpha:1}
      : {fill:cssVar('--z-norm-dim-fill'),stroke:cssVar('--z-norm-dim'),width:1.2,fillAlpha:1};
  }

  function targetRadius(){
    return matchMedia('(max-width: 768px)').matches?5:6;
  }

  function drawHandles(pts){
    if(!pts || !pts.length) return;
    const color=currentZone==='excl'?cssVar('--z-excl'):cssVar('--z-norm');
    for(let i=0;i<pts.length;i++){
      const px=toPxX(pts[i].x), py=toPxY(pts[i].y);
      ctx.beginPath();
      ctx.arc(px,py,5.5,0,Math.PI*2);
      ctx.fillStyle=i===dragIdx?'#22c55e':color;
      ctx.fill();
    }
  }

  function drawTargets(){
    if(viewDim !== '2d') return;

    const color = cssVar('--pulse') || '#22c55e';
    const r = targetRadius();
    for (const n of [1, 2, 3]) {
      const p = livePos[n];
      if (!p || !Number.isFinite(p.x) || !Number.isFinite(p.y) || (p.x === 0 && p.y === 0)) continue;
      const px = toPxX(clamp(p.x, X_MIN, X_MAX));
      const py = toPxY(clamp(p.y, Y_MIN, Y_MAX));
      ctx.beginPath();
      ctx.arc(px, py, r, 0, Math.PI * 2);
      ctx.fillStyle = color;
      ctx.fill();
    }
  }

  async function fetchHistoricalData(entityIds,hours=24){
    if(!selectedDevice) return [];
    setStatus('',`Fetching ${hours}h data…`);
    try{
      const body=(entityIds&&entityIds.length)
        ? {entity_ids:entityIds,hours}
        : {device_id:selectedDevice.device_id,hours};
      const res=await api('api/historical_targets',body);
      const positions=res.positions||[];
      setStatus('ok',`Loaded ${positions.length} positions`);
      return positions;
    }catch(e){
      setStatus('err','Failed to fetch history: '+e.message);
      return [];
    }
  }

  function buildPalette(){
    const stops=[
      [0,[13,32,56]],
      [0.12,[42,123,255]],
      [0.35,[65,255,212]],
      [0.6,[166,255,99]],
      [0.8,[255,224,102]],
      [0.92,[255,154,92]],
      [1,[255,107,107]]
    ];
    const lut=new Uint8ClampedArray(256*4);
    for(let i=0;i<256;i++){
      const t=i/255;
      let a=stops[0], b=stops[stops.length-1];
      for(let s=1;s<stops.length;s++){
        if(t<=stops[s][0]){
          a=stops[s-1];
          b=stops[s];
          break;
        }
      }
      const span=(b[0]-a[0])||1;
      const k=(t-a[0])/span;
      const r=Math.round(a[1][0]+(b[1][0]-a[1][0])*k);
      const g=Math.round(a[1][1]+(b[1][1]-a[1][1])*k);
      const bl=Math.round(a[1][2]+(b[1][2]-a[1][2])*k);
      const off=i*4;
      lut[off]=r;
      lut[off+1]=g;
      lut[off+2]=bl;
      lut[off+3]=255;
    }
    return lut;
  }
  const PALETTE=buildPalette();

  function gaussianKernel1D(sigma){
    const radius = Math.max(1, Math.ceil(sigma * 3));
    const size = radius*2 + 1;
    const k = new Float32Array(size);
    const s2 = 2*sigma*sigma;
    let sum = 0;
    for(let i=-radius, idx=0; i<=radius; i++, idx++){
      const v = Math.exp(-(i*i)/s2);
      k[idx]=v;
      sum+=v;
    }
    for(let i=0;i<size;i++) k[i]/=sum;
    return {k, radius, size};
  }

  function kdeHeatmap(points, w, h){
    const grid = new Float32Array(w*h);
    const pw = Math.max(0.01, TUNE.pointWeight);
    for(const p of points){
      const x = (p.x - X_MIN) / WORLD_W * (w-1);
      const y = (p.y - Y_MIN) / WORLD_H * (h-1);
      if(!Number.isFinite(x) || !Number.isFinite(y)) continue;
      if(x<0||x>w-1||y<0||y>h-1) continue;
      const x0 = Math.floor(x), y0 = Math.floor(y);
      const dx = x - x0, dy = y - y0;
      const x1 = Math.min(w-1, x0+1), y1 = Math.min(h-1, y0+1);
      const w00 = (1-dx)*(1-dy)*pw, w10 = dx*(1-dy)*pw, w01 = (1-dx)*dy*pw, w11 = dx*dy*pw;
      grid[y0*w + x0] += w00;
      grid[y0*w + x1] += w10;
      grid[y1*w + x0] += w01;
      grid[y1*w + x1] += w11;
    }
    return grid;
  }

  function normalizeDensity(values){
    let maxV = 0;
    const samples = [];
    for(let i=0;i<values.length;i++){
      const v = values[i];
      if(v>0){
        samples.push(v);
        if(v>maxV) maxV=v;
      }
    }
    let norm = maxV || 1;
    if(samples.length){
      samples.sort((a,b)=>a-b);
      const p = Math.max(0.5, Math.min(0.999, TUNE.clipPercentile));
      norm = samples[Math.floor(samples.length * p)] || norm;
    }
    const gamma = Math.max(0.2, TUNE.gamma);
    const cutoff = Math.max(0, Math.min(0.95, TUNE.minCutoff));
    const out = new Float32Array(values.length);

    for(let i=0;i<values.length;i++){
      const v = values[i];
      if(v<=0){ out[i]=0; continue; }
      let t = Math.min(1, v / norm);
      if(t < cutoff){ out[i]=0; continue; }
      t = (t - cutoff) / (1 - cutoff);
      t = Math.pow(t, gamma);
      out[i]=t;
    }
    return out;
  }

  function normalizeHeight(values){
    let maxV = 0;
    for(let i=0;i<values.length;i++){
      if(values[i] > maxV) maxV = values[i];
    }
    const norm = maxV || 1;
    const out = new Float32Array(values.length);
    const gamma = 0.85;
    for(let i=0;i<values.length;i++){
      const v = values[i];
      if(v<=0){ out[i]=0; continue; }
      let t = v / norm;
      if(t < 0) t = 0;
      if(t > 1) t = 1;
      out[i] = Math.pow(t, gamma);
    }
    return out;
  }

  function ensureHeatmapField(){
    const w = Math.max(2, Math.round(innerW()));
    const h = Math.max(2, Math.round(innerH()));
    if(!heatmapPositions.length){
      heatmapFieldColor=null;
      heatmapFieldHeight=null;
      return null;
    }
    if(heatmapFieldColor && heatmapFieldHeight && heatmapFieldW===w && heatmapFieldH===h){
      return {color:heatmapFieldColor, height:heatmapFieldHeight, w, h};
    }

    const base = kdeHeatmap(heatmapPositions, w, h);
    const N = Math.max(1, heatmapPositions.length);
    const meanSpacing = Math.sqrt((w*h)/N);
    const sigma0 = Math.max(1.5, Math.min(Math.min(w,h)*0.08, meanSpacing*0.9));
    const sigma = sigma0 * TUNE.sigmaScale;
    const {k, radius} = gaussianKernel1D(sigma);

    const tmp = new Float32Array(w*h);
    for(let y=0; y<h; y++){
      const off = y*w;
      for(let x=0; x<w; x++){
        let acc=0;
        for(let i=-radius, idx=0; i<=radius; i++, idx++){
          const xx = Math.max(0, Math.min(w-1, x+i));
          acc += base[off + xx] * k[idx];
        }
        tmp[off + x] = acc;
      }
    }

    const blurred = new Float32Array(w*h);
    for(let x=0; x<w; x++){
      for(let y=0; y<h; y++){
        let acc=0;
        for(let i=-radius, idx=0; i<=radius; i++, idx++){
          const yy = Math.max(0, Math.min(h-1, y+i));
          acc += tmp[yy*w + x] * k[idx];
        }
        blurred[y*w + x] = acc;
      }
    }

    const density = normalizeDensity(blurred);

    const masked = new Float32Array(blurred.length);
    for(let i=0;i<blurred.length;i++){
      masked[i] = blurred[i] * density[i];
    }

    heatmapFieldColor  = density;
    heatmapFieldHeight = normalizeHeight(masked);
    heatmapFieldW = w;
    heatmapFieldH = h;
    return {color:heatmapFieldColor, height:heatmapFieldHeight, w, h};
  }

  function colorizeAndDrawField(fieldColor, w, h){
    const img = ctx.createImageData(w,h);
    const d   = img.data;
    const aMax = Math.max(0, Math.min(255, TUNE.maxAlpha));

    for(let i=0;i<fieldColor.length;i++){
      const t = fieldColor[i];
      if(t<=0){ d[i*4+3]=0; continue; }
      const idx = Math.min(255, (t*255)|0);
      const o   = idx*4;
      d[i*4]   = PALETTE[o];
      d[i*4+1] = PALETTE[o+1];
      d[i*4+2] = PALETTE[o+2];
      d[i*4+3] = Math.round(35 + (aMax-35)*t);
    }

    ctx.save();
    const pts = makeFovPoints(detRange>0?detRange:MAX_RANGE);
    ctx.beginPath();
    const sx = w/WORLD_W, sy = h/WORLD_H;
    ctx.moveTo(PAD + (pts[0].x - X_MIN)*sx, PAD + (pts[0].y - Y_MIN)*sy);
    for(let i=1;i<pts.length;i++){
      ctx.lineTo(PAD + (pts[i].x - X_MIN)*sx, PAD + (pts[i].y - Y_MIN)*sy);
    }
    ctx.closePath();
    ctx.clip();

    const offscreen = document.createElement('canvas');
    offscreen.width  = w;
    offscreen.height = h;
    offscreen.getContext('2d').putImageData(img,0,0);
    ctx.drawImage(offscreen, PAD, PAD);
    ctx.restore();
  }

  function drawHeatmap2D(){
    if(viewMode!=='heatmap' || !heatmapPositions.length) return;
    const cached = ensureHeatmapField();
    if(!cached) return;
    colorizeAndDrawField(cached.color, cached.w, cached.h);
  }

  function updateCamera3D(){
    const iw = innerW();
    const ih = innerH();
    cam3D.aspect = iw / ih;

    const centerX = (X_MIN + X_MAX) * 0.5;
    const centerZ = (Y_MIN + Y_MAX) * 0.5;

    cam3D.target.x = centerX;
    cam3D.target.y = 0;
    cam3D.target.z = centerZ;

    ORBIT.distance  = clamp(ORBIT.distance,  ORBIT_LIMITS.minDist, ORBIT_LIMITS.maxDist);
    ORBIT.elevation = clamp(ORBIT.elevation, ORBIT_LIMITS.minElev, ORBIT_LIMITS.maxElev);

    cam3D.cosA = Math.cos(ORBIT.azimuth);
    cam3D.sinA = Math.sin(ORBIT.azimuth);
    cam3D.cosE = Math.cos(ORBIT.elevation);
    cam3D.sinE = Math.sin(ORBIT.elevation);

    cam3D.pos.x = cam3D.target.x + ORBIT.distance * cam3D.cosE * cam3D.sinA;
    cam3D.pos.y = cam3D.target.y + ORBIT.distance * cam3D.sinE;
    cam3D.pos.z = cam3D.target.z + ORBIT.distance * cam3D.cosE * cam3D.cosA;

    const fovRad = cam3D.fovDeg * Math.PI / 180;
    cam3D.scale = (ih * 0.5) / Math.tan(fovRad / 2);

    cam3D.cx = PAD + iw * 0.5;
    cam3D.cy = PAD + ih * 0.5;
  }

  function worldToCamera(wx,wy,wz){
    const dx = wx - cam3D.pos.x;
    const dy = wy - cam3D.pos.y;
    const dz = wz - cam3D.pos.z;

    const x1 =  cam3D.cosA * dx - cam3D.sinA * dz;
    const z1 =  cam3D.sinA * dx + cam3D.cosA * dz;

    const y1 =  cam3D.cosE * dy - cam3D.sinE * z1;
    const z2 =  cam3D.sinE * dy + cam3D.cosE * z1;

    const z = -z2;
    return {x:x1, y:y1, z};
  }

  function project3D(wx,wy,wz){
    const p = worldToCamera(wx,wy,wz);
    if(p.z <= cam3D.near) return null;
    const sx = cam3D.cx + (p.x * cam3D.scale)/p.z;
    const sy = cam3D.cy - (p.y * cam3D.scale)/p.z;
    return {x:sx, y:sy, z:p.z};
  }

  function drawGrid3D(){
    const gridColor=cssVar('--grid')||'#1e2431';
    ctx.save();
    ctx.lineWidth=1;
    ctx.strokeStyle=gridColor;
    ctx.globalAlpha=0.8;

    const step = GRID;
    const maxDepth = MAX_RANGE;

    for(let x=Math.ceil(X_MIN/step)*step;x<=X_MAX;x+=step){
      const p0 = project3D(x,0,0);
      const p1 = project3D(x,0,maxDepth);
      if(!p0 || !p1) continue;
      ctx.beginPath();
      ctx.moveTo(p0.x,p0.y);
      ctx.lineTo(p1.x,p1.y);
      ctx.stroke();
    }
    for(let z=0; z<=maxDepth; z+=step){
      const p0 = project3D(X_MIN,0,z);
      const p1 = project3D(X_MAX,0,z);
      if(!p0 || !p1) continue;
      ctx.beginPath();
      ctx.moveTo(p0.x,p0.y);
      ctx.lineTo(p1.x,p1.y);
      ctx.stroke();
    }

    ctx.globalAlpha=1;
    ctx.restore();
  }

  function drawFov3D(range,lighter=false){
    const r = Math.max(0, Math.min(MAX_RANGE, range|0));
    if(!r) return;

    const half = FOV_DEG/2;
    const rad  = Math.PI/180;

    const pts=[];
    pts.push({x:0,y:0,z:0});
    for(let a=-half; a<=half; a+=3){
      pts.push({
        x: r*Math.sin(a*rad),
        y: 0,
        z: r*Math.cos(a*rad)
      });
    }
    pts.push({x:0,y:0,z:0});

    ctx.save();

    ctx.beginPath();
    let first=true;
    for(const w of pts){
      const p=project3D(w.x,w.y,w.z);
      if(!p) continue;
      if(first){ ctx.moveTo(p.x,p.y); first=false; }
      else ctx.lineTo(p.x,p.y);
    }
    if(!first){
      ctx.closePath();
      ctx.globalAlpha=lighter?0.10:0.18;
      ctx.fillStyle=cssVar('--fov');
      ctx.fill();
    }

    ctx.globalAlpha=1;
    ctx.restore();
  }

  function softFovFactor(x,z,range){
    const r = Math.hypot(x,z);
    const ang = Math.atan2(x,z);
    const half = FOV_RAD * 0.5;

    const bandR = 30;
    const bandA = 5 * Math.PI/180;

    const absA = Math.abs(ang);

    let fRad;
    if(r <= range - bandR)      fRad = 1;
    else if(r >= range)         fRad = 0;
    else {
      const t = (range - r) / bandR;
      fRad = smoothstep01(t);
    }

    let fAng;
    if(absA <= half - bandA)    fAng = 1;
    else if(absA >= half)       fAng = 0;
    else {
      const t = (half - absA) / bandA;
      fAng = smoothstep01(t);
    }

    return fRad * fAng;
  }

  function softWorldFactor(x,z){
    const band = 30;
    let fx = 1, fz = 1;

    if(x <= X_MIN) return 0;
    if(x < X_MIN + band){
      const t = (x - X_MIN) / band;
      fx *= smoothstep01(t);
    }
    if(x >= X_MAX) return 0;
    if(x > X_MAX - band){
      const t = (X_MAX - x) / band;
      fx *= smoothstep01(t);
    }

    if(z <= Y_MIN) return 0;
    if(z < Y_MIN + band){
      const t = (z - Y_MIN) / band;
      fz *= smoothstep01(t);
    }
    if(z >= Y_MAX) return 0;
    if(z > Y_MAX - band){
      const t = (Y_MAX - z) / band;
      fz *= smoothstep01(t);
    }

    return fx * fz;
  }

  function sampleFieldAt(arr, w, h, worldX, worldZ){
    let u = (worldX - X_MIN) / WORLD_W;
    let v = (worldZ - Y_MIN) / WORLD_H;
    if(u<0||u>1||v<0||v>1) return 0;
    const x = u*(w-1);
    const y = v*(h-1);
    const x0 = Math.floor(x), y0 = Math.floor(y);
    const x1 = Math.min(w-1,x0+1), y1 = Math.min(h-1,y0+1);
    const dx = x - x0, dy = y - y0;

    const i00 = y0*w + x0;
    const i10 = y0*w + x1;
    const i01 = y1*w + x0;
    const i11 = y1*w + x1;

    const v00 = arr[i00], v10 = arr[i10], v01 = arr[i01], v11 = arr[i11];

    const v0 = v00*(1-dx) + v10*dx;
    const v1 = v01*(1-dx) + v11*dx;
    return v0*(1-dy) + v1*dy;
  }

  function drawHeatmap3D(){
    if(viewMode!=='heatmap' || viewDim!=='3d') return;
    const cached = ensureHeatmapField();
    if(!cached) return;
    const {color,height,w,h} = cached;

    const scale = Math.min(HEATMAP3D_MAX_RES/w, HEATMAP3D_MAX_RES/h, 1);
    const gw = Math.max(2, Math.floor(w * scale));
    const gh = Math.max(2, Math.floor(h * scale));

    const vertices = Array.from({length:gh}, ()=>Array(gw));
    const rDet = detRange>0 ? detRange : MAX_RANGE;

    for(let gy=0; gy<gh; gy++){
      const vz = Y_MIN + (gy/(gh-1))*WORLD_H;
      for(let gx=0; gx<gw; gx++){
        const vx = X_MIN + (gx/(gw-1))*WORLD_W;

        const baseColor  = sampleFieldAt(color , w, h, vx, vz);
        let   baseHeight = baseColor>0 ? sampleFieldAt(height, w, h, vx, vz) : 0;

        const fFov   = softFovFactor(vx, vz, rDet);
        const fWorld = softWorldFactor(vx, vz);
        const f      = fFov * fWorld;

        const tColor  = baseColor  * f;
        const tHeight = baseHeight * f;

        const hCm = tHeight * HEATMAP_MAX_HEIGHT_CM;
        const proj = hCm>0 ? project3D(vx,hCm,vz) : project3D(vx,0,vz);
        vertices[gy][gx] = {
          sx: proj ? proj.x : null,
          sy: proj ? proj.y : null,
          depth: proj ? proj.z : Infinity,
          tColor,
          tHeight,
          worldX: vx,
          worldZ: vz
        };
      }
    }

    const tris=[];
    for(let gy=0; gy<gh-1; gy++){
      for(let gx=0; gx<gw-1; gx++){
        const v00 = vertices[gy][gx];
        const v10 = vertices[gy][gx+1];
        const v01 = vertices[gy+1][gx];
        const v11 = vertices[gy+1][gx+1];

        if(!v00 || !v10 || !v01 || !v11) continue;

        function pushTri(a,b,c){
          if(a.sx==null || b.sx==null || c.sx==null) return;
          const tAvg = (a.tColor + b.tColor + c.tColor)/3;
          if(tAvg<=0) return;
          const depth = (a.depth + b.depth + c.depth)/3;
          tris.push({a,b,c,t:tAvg,depth});
        }

        pushTri(v00,v10,v01);
        pushTri(v10,v11,v01);
      }
    }

    tris.sort((a,b)=>b.depth - a.depth);

    ctx.save();
    for(const tri of tris){
      const t = tri.t;
      const idx = Math.min(255,(t*255)|0)*4;
      const rCol = PALETTE[idx];
      const gCol = PALETTE[idx+1];
      const bCol = PALETTE[idx+2];
      const alpha = 0.25 + 0.55*t;

      ctx.beginPath();
      ctx.moveTo(tri.a.sx,tri.a.sy);
      ctx.lineTo(tri.b.sx,tri.b.sy);
      ctx.lineTo(tri.c.sx,tri.c.sy);
      ctx.closePath();
      ctx.fillStyle = `rgb(${rCol},${gCol},${bCol})`;
      ctx.globalAlpha = alpha;
      ctx.fill();
    }
    ctx.restore();
  }

  function drawZones3D(){
    const wallH = WALL_HEIGHT_CM;
    const walls = [];

    ctx.save();
    for(const key of ['1','2','3','excl']){
      const pts = zones[key];
      if(!pts || pts.length<2) continue;
      const active = currentZone && key===currentZone;
      const style = zoneStyle(key, active);

      ctx.beginPath();
      let first = true;
      for(const pt of pts){
        const p = project3D(pt.x,0,pt.y);
        if(!p) continue;
        if(first){ ctx.moveTo(p.x,p.y); first=false; }
        else ctx.lineTo(p.x,p.y);
      }
      if(!first && pts.length>=3) ctx.closePath();

      if(style.fill){
        ctx.globalAlpha = (style.fillAlpha ?? 1) * 0.9;
        ctx.fillStyle   = style.fill;
        ctx.fill();
      }
      if(style.stroke){
        ctx.globalAlpha = 1;
        ctx.lineWidth   = style.width ?? 2;
        ctx.strokeStyle = style.stroke;
        ctx.stroke();
      }

      const n = pts.length;
      for(let i=0;i<n;i++){
        const j=(i+1)%n;
        const p0=pts[i], p1=pts[j];
        const b0 = project3D(p0.x,0,p0.y);
        const b1 = project3D(p1.x,0,p1.y);
        const t0 = project3D(p0.x,wallH,p0.y);
        const t1 = project3D(p1.x,wallH,p1.y);
        if(!b0 || !b1 || !t0 || !t1) continue;
        const depth = (b0.z + b1.z + t0.z + t1.z)/4;
        walls.push({b0,b1,t0,t1,style,depth});
      }
    }

    walls.sort((a,b)=>b.depth - a.depth);
    for(const w of walls){
      const style=w.style;
      if(style.fill){
        ctx.globalAlpha = (style.fillAlpha ?? 1) * 0.9;
        ctx.beginPath();
        ctx.moveTo(w.b0.x,w.b0.y);
        ctx.lineTo(w.b1.x,w.b1.y);
        ctx.lineTo(w.t1.x,w.t1.y);
        ctx.lineTo(w.t0.x,w.t0.y);
        ctx.closePath();
        ctx.fillStyle = style.fill;
        ctx.fill();
      }
      if(style.stroke){
        ctx.globalAlpha = 1;
        ctx.beginPath();
        ctx.moveTo(w.b0.x,w.b0.y);
        ctx.lineTo(w.b1.x,w.b1.y);
        ctx.lineTo(w.t1.x,w.t1.y);
        ctx.lineTo(w.t0.x,w.t0.y);
        ctx.closePath();
        ctx.strokeStyle = style.stroke;
        ctx.lineWidth = (style.width ?? 2) * 0.7;
        ctx.stroke();
      }
    }

    ctx.globalAlpha=1;
    ctx.restore();
  }

const HUMAN_TRIANGLES = [
  [{x:-7.61, y:172.57, z:-8.41}, {x:-7.9, y:165.93, z:-4.32}, {x:-2.67, y:161.54, z:-10.64}],
  [{x:-13.86, y:0.0, z:12.08}, {x:-16.48, y:2.9, z:10.58}, {x:-13.78, y:4.9, z:3.64}],
  [{x:-21.86, y:0.0, z:9.58}, {x:-16.48, y:2.9, z:10.58}, {x:-13.86, y:0.0, z:12.08}],
  [{x:-6.06, y:159.44, z:-2.83}, {x:-2.67, y:161.54, z:-10.64}, {x:-7.9, y:165.93, z:-4.32}],
  [{x:-2.67, y:161.54, z:-10.64}, {x:0.42, y:174.34, z:-12.68}, {x:-7.61, y:172.57, z:-8.41}],
  [{x:-11.42, y:15.46, z:-8.64}, {x:-11.49, y:0.0, z:-3.66}, {x:-14.98, y:11.23, z:-4.79}],
  [{x:-11.41, y:0.0, z:-11.73}, {x:-11.49, y:0.0, z:-3.66}, {x:-13.31, y:12.02, z:-12.33}],
  [{x:-13.31, y:12.02, z:-12.33}, {x:-11.49, y:0.0, z:-3.66}, {x:-11.42, y:15.46, z:-8.64}],
  [{x:-5.1, y:178.24, z:-4.79}, {x:-7.61, y:172.57, z:-8.41}, {x:0.42, y:174.34, z:-12.68}],
  [{x:0.42, y:180.0, z:-2.63}, {x:-5.1, y:178.24, z:-4.79}, {x:0.42, y:174.34, z:-12.68}],
  [{x:5.7, y:59.8, z:1.13}, {x:12.19, y:42.1, z:-1.96}, {x:5.78, y:50.98, z:-4.62}],
  [{x:-6.7, y:175.25, z:3.19}, {x:-5.79, y:165.74, z:5.99}, {x:-7.9, y:165.93, z:-4.32}],
  [{x:-7.61, y:172.57, z:-8.41}, {x:-6.7, y:175.25, z:3.19}, {x:-7.9, y:165.93, z:-4.32}],
  [{x:16.97, y:53.05, z:-5.05}, {x:14.36, y:86.8, z:-11.24}, {x:13.19, y:52.92, z:-11.13}],
  [{x:-6.7, y:175.25, z:3.19}, {x:-7.61, y:172.57, z:-8.41}, {x:-5.1, y:178.24, z:-4.79}],
  [{x:-5.1, y:178.24, z:-4.79}, {x:0.42, y:180.0, z:-2.63}, {x:-6.7, y:175.25, z:3.19}],
  [{x:0.69, y:168.11, z:9.89}, {x:0.5, y:175.78, z:6.9}, {x:7.25, y:175.34, z:1.67}],
  [{x:14.36, y:86.8, z:-11.24}, {x:6.19, y:92.33, z:-13.85}, {x:11.53, y:77.33, z:-10.97}],
  [{x:3.43, y:81.72, z:-11.37}, {x:11.53, y:77.33, z:-10.97}, {x:6.19, y:92.33, z:-13.85}],
  [{x:-3.02, y:154.6, z:-10.54}, {x:-18.73, y:147.28, z:-4.81}, {x:-17.75, y:141.37, z:-11.91}],
  [{x:-3.45, y:154.98, z:2.21}, {x:-2.54, y:148.17, z:0.54}, {x:-6.09, y:151.19, z:-4.18}],
  [{x:-18.73, y:147.28, z:-4.81}, {x:-3.02, y:154.6, z:-10.54}, {x:-6.09, y:151.19, z:-4.18}],
  [{x:-3.02, y:154.6, z:-10.54}, {x:-6.06, y:159.44, z:-2.83}, {x:-6.09, y:151.19, z:-4.18}],
  [{x:-2.12, y:84.1, z:7.3}, {x:8.85, y:91.09, z:9.28}, {x:2.25, y:83.51, z:5.28}],
  [{x:-7.9, y:165.93, z:-4.32}, {x:-5.79, y:165.74, z:5.99}, {x:-6.06, y:159.44, z:-2.83}],
  [{x:-17.75, y:141.37, z:-11.91}, {x:3.33, y:147.61, z:-14.57}, {x:-3.02, y:154.6, z:-10.54}],
  [{x:14.36, y:86.8, z:-11.24}, {x:18.54, y:73.06, z:1.34}, {x:13.14, y:109.79, z:-2.09}],
  [{x:-2.67, y:161.54, z:-10.64}, {x:-6.06, y:159.44, z:-2.83}, {x:-3.02, y:154.6, z:-10.54}],
  [{x:-6.8, y:137.5, z:8.41}, {x:-18.73, y:147.28, z:-4.81}, {x:-2.54, y:148.17, z:0.54}],
  [{x:-6.09, y:151.19, z:-4.18}, {x:-2.54, y:148.17, z:0.54}, {x:-18.73, y:147.28, z:-4.81}],
  [{x:9.95, y:139.4, z:6.21}, {x:3.51, y:131.96, z:10.76}, {x:4.07, y:147.56, z:0.76}],
  [{x:3.43, y:81.72, z:-11.37}, {x:0.64, y:85.75, z:-12.63}, {x:-0.29, y:81.68, z:-1.88}],
  [{x:6.19, y:92.33, z:-13.85}, {x:0.64, y:85.75, z:-12.63}, {x:3.43, y:81.72, z:-11.37}],
  [{x:0.64, y:85.75, z:-12.63}, {x:-2.56, y:81.23, z:-11.18}, {x:-0.29, y:81.68, z:-1.88}],
  [{x:11.97, y:130.4, z:7.73}, {x:3.51, y:131.96, z:10.76}, {x:9.95, y:139.4, z:6.21}],
  [{x:28.18, y:111.52, z:-9.83}, {x:21.09, y:135.11, z:-11.24}, {x:17.95, y:131.19, z:-11.0}],
  [{x:27.69, y:129.55, z:-5.45}, {x:20.74, y:143.49, z:-8.79}, {x:21.09, y:135.11, z:-11.24}],
  [{x:21.09, y:135.11, z:-11.24}, {x:9.75, y:134.32, z:-16.79}, {x:17.95, y:131.19, z:-11.0}],
  [{x:20.74, y:143.49, z:-8.79}, {x:9.75, y:134.32, z:-16.79}, {x:21.09, y:135.11, z:-11.24}],
  [{x:29.4, y:117.63, z:-0.4}, {x:23.5, y:116.08, z:-2.73}, {x:18.91, y:132.39, z:0.83}],
  [{x:18.57, y:140.73, z:-0.07}, {x:18.91, y:132.39, z:0.83}, {x:11.97, y:130.4, z:7.73}],
  [{x:16.9, y:129.04, z:-8.16}, {x:11.97, y:130.4, z:7.73}, {x:18.91, y:132.39, z:0.83}],
  [{x:11.97, y:130.4, z:7.73}, {x:9.95, y:139.4, z:6.21}, {x:18.57, y:140.73, z:-0.07}],
  [{x:13.19, y:52.92, z:-11.13}, {x:17.93, y:32.42, z:-13.03}, {x:16.97, y:53.05, z:-5.05}],
  [{x:19.44, y:31.72, z:-8.19}, {x:16.97, y:53.05, z:-5.05}, {x:17.93, y:32.42, z:-13.03}],
  [{x:5.78, y:50.98, z:-4.62}, {x:8.26, y:42.01, z:-7.97}, {x:9.53, y:46.2, z:-11.28}],
  [{x:16.97, y:53.05, z:-5.05}, {x:19.44, y:31.72, z:-8.19}, {x:15.43, y:42.67, z:-2.11}],
  [{x:12.19, y:42.1, z:-1.96}, {x:8.26, y:42.01, z:-7.97}, {x:5.78, y:50.98, z:-4.62}],
  [{x:13.19, y:52.92, z:-11.13}, {x:12.78, y:32.3, z:-15.34}, {x:17.93, y:32.42, z:-13.03}],
  [{x:9.53, y:46.2, z:-11.28}, {x:12.78, y:32.3, z:-15.34}, {x:13.19, y:52.92, z:-11.13}],
  [{x:-13.17, y:52.92, z:-11.13}, {x:-14.84, y:86.67, z:-10.51}, {x:-16.96, y:53.05, z:-5.05}],
  [{x:12.78, y:32.3, z:-15.34}, {x:9.53, y:46.2, z:-11.28}, {x:7.94, y:30.17, z:-10.24}],
  [{x:8.26, y:42.01, z:-7.97}, {x:7.94, y:30.17, z:-10.24}, {x:9.53, y:46.2, z:-11.28}],
  [{x:12.19, y:42.1, z:-1.96}, {x:7.94, y:30.17, z:-10.24}, {x:8.26, y:42.01, z:-7.97}],
  [{x:-15.41, y:42.67, z:-2.11}, {x:-19.42, y:31.72, z:-8.19}, {x:-16.96, y:53.05, z:-5.05}],
  [{x:13.33, y:12.02, z:-12.33}, {x:12.78, y:32.3, z:-15.34}, {x:7.94, y:30.17, z:-10.24}],
  [{x:-5.6, y:51.18, z:-4.28}, {x:-12.17, y:42.15, z:-1.95}, {x:-5.55, y:60.2, z:1.32}],
  [{x:17.93, y:32.42, z:-13.03}, {x:12.78, y:32.3, z:-15.34}, {x:13.33, y:12.02, z:-12.33}],
  [{x:13.33, y:12.02, z:-12.33}, {x:7.94, y:30.17, z:-10.24}, {x:11.44, y:15.46, z:-8.64}],
  [{x:-8.24, y:42.01, z:-7.97}, {x:-5.6, y:51.18, z:-4.28}, {x:-9.51, y:46.2, z:-11.28}],
  [{x:-12.76, y:32.3, z:-15.34}, {x:-9.51, y:46.2, z:-11.28}, {x:-13.17, y:52.92, z:-11.13}],
  [{x:-15.41, y:42.67, z:-2.11}, {x:-12.17, y:42.15, z:-1.95}, {x:-14.98, y:11.23, z:-4.79}],
  [{x:13.88, y:0.0, z:12.01}, {x:13.53, y:4.3, z:4.43}, {x:16.37, y:3.4, z:9.94}],
  [{x:13.53, y:4.3, z:4.43}, {x:11.51, y:0.0, z:-3.66}, {x:14.87, y:10.9, z:-4.45}],
  [{x:11.51, y:0.0, z:-3.66}, {x:13.53, y:4.3, z:4.43}, {x:13.88, y:0.0, z:12.01}],
  [{x:-8.24, y:42.01, z:-7.97}, {x:-12.17, y:42.15, z:-1.95}, {x:-5.6, y:51.18, z:-4.28}],
  [{x:-17.91, y:32.42, z:-13.03}, {x:-16.96, y:53.05, z:-5.05}, {x:-19.42, y:31.72, z:-8.19}],
  [{x:14.87, y:10.9, z:-4.45}, {x:12.19, y:42.1, z:-1.96}, {x:15.43, y:42.67, z:-2.11}],
  [{x:-13.17, y:52.92, z:-11.13}, {x:-16.96, y:53.05, z:-5.05}, {x:-17.91, y:32.42, z:-13.03}],
  [{x:-13.17, y:52.92, z:-11.13}, {x:-17.91, y:32.42, z:-13.03}, {x:-12.76, y:32.3, z:-15.34}],
  [{x:13.33, y:12.02, z:-12.33}, {x:11.44, y:15.46, z:-8.64}, {x:11.51, y:0.0, z:-3.66}],
  [{x:11.43, y:0.0, z:-11.73}, {x:13.33, y:12.02, z:-12.33}, {x:11.51, y:0.0, z:-3.66}],
  [{x:-6.08, y:91.58, z:-14.06}, {x:-11.13, y:77.7, z:-10.99}, {x:-2.56, y:81.23, z:-11.18}],
  [{x:11.43, y:0.0, z:-11.73}, {x:16.44, y:0.0, z:-13.34}, {x:13.33, y:12.02, z:-12.33}],
  [{x:-11.13, y:77.7, z:-10.99}, {x:-6.08, y:91.58, z:-14.06}, {x:-14.84, y:86.67, z:-10.51}],
  [{x:11.51, y:0.0, z:-3.66}, {x:11.44, y:15.46, z:-8.64}, {x:14.87, y:10.9, z:-4.45}],
  [{x:-6.08, y:91.58, z:-14.06}, {x:-2.56, y:81.23, z:-11.18}, {x:0.64, y:85.75, z:-12.63}],
  [{x:11.54, y:73.59, z:7.98}, {x:2.25, y:83.51, z:5.28}, {x:8.85, y:91.09, z:9.28}],
  [{x:13.19, y:52.92, z:-11.13}, {x:11.53, y:77.33, z:-10.97}, {x:3.43, y:81.72, z:-11.37}],
  [{x:9.53, y:46.2, z:-11.28}, {x:13.19, y:52.92, z:-11.13}, {x:3.43, y:81.72, z:-11.37}],
  [{x:14.36, y:86.8, z:-11.24}, {x:11.53, y:77.33, z:-10.97}, {x:13.19, y:52.92, z:-11.13}],
  [{x:5.78, y:50.98, z:-4.62}, {x:-0.29, y:81.68, z:-1.88}, {x:2.25, y:83.51, z:5.28}],
  [{x:11.54, y:73.59, z:7.98}, {x:8.85, y:91.09, z:9.28}, {x:18.54, y:73.06, z:1.34}],
  [{x:-2.12, y:84.1, z:7.3}, {x:2.25, y:83.51, z:5.28}, {x:-0.29, y:81.68, z:-1.88}],
  [{x:16.97, y:53.05, z:-5.05}, {x:18.54, y:73.06, z:1.34}, {x:14.36, y:86.8, z:-11.24}],
  [{x:15.43, y:42.67, z:-2.11}, {x:18.54, y:73.06, z:1.34}, {x:16.97, y:53.05, z:-5.05}],
  [{x:3.43, y:81.72, z:-11.37}, {x:-0.29, y:81.68, z:-1.88}, {x:9.53, y:46.2, z:-11.28}],
  [{x:5.78, y:50.98, z:-4.62}, {x:9.53, y:46.2, z:-11.28}, {x:-0.29, y:81.68, z:-1.88}],
  [{x:12.19, y:42.1, z:-1.96}, {x:5.7, y:59.8, z:1.13}, {x:11.54, y:73.59, z:7.98}],
  [{x:-5.55, y:60.2, z:1.32}, {x:-2.12, y:84.1, z:7.3}, {x:-0.29, y:81.68, z:-1.88}],
  [{x:11.54, y:73.59, z:7.98}, {x:5.7, y:59.8, z:1.13}, {x:2.25, y:83.51, z:5.28}],
  [{x:18.54, y:73.06, z:1.34}, {x:12.19, y:42.1, z:-1.96}, {x:11.54, y:73.59, z:7.98}],
  [{x:18.54, y:73.06, z:1.34}, {x:15.43, y:42.67, z:-2.11}, {x:12.19, y:42.1, z:-1.96}],
  [{x:5.78, y:50.98, z:-4.62}, {x:2.25, y:83.51, z:5.28}, {x:5.7, y:59.8, z:1.13}],
  [{x:36.91, y:82.3, z:-0.36}, {x:35.69, y:93.76, z:-0.06}, {x:34.8, y:92.64, z:-3.71}],
  [{x:31.73, y:92.65, z:-3.16}, {x:33.37, y:83.32, z:-2.28}, {x:34.8, y:92.64, z:-3.71}],
  [{x:-2.56, y:81.23, z:-11.18}, {x:-11.13, y:77.7, z:-10.99}, {x:-13.17, y:52.92, z:-11.13}],
  [{x:-13.17, y:52.92, z:-11.13}, {x:-11.13, y:77.7, z:-10.99}, {x:-14.84, y:86.67, z:-10.51}],
  [{x:-13.17, y:52.92, z:-11.13}, {x:-9.51, y:46.2, z:-11.28}, {x:-2.56, y:81.23, z:-11.18}],
  [{x:4.07, y:147.56, z:0.76}, {x:-6.8, y:137.5, z:8.41}, {x:-2.54, y:148.17, z:0.54}],
  [{x:-5.79, y:165.74, z:5.99}, {x:0.55, y:156.87, z:8.06}, {x:-3.45, y:154.98, z:2.21}],
  [{x:-6.06, y:159.44, z:-2.83}, {x:-5.79, y:165.74, z:5.99}, {x:-3.45, y:154.98, z:2.21}],
  [{x:-6.09, y:151.19, z:-4.18}, {x:-6.06, y:159.44, z:-2.83}, {x:-3.45, y:154.98, z:2.21}],
  [{x:0.55, y:156.87, z:8.06}, {x:4.28, y:155.17, z:2.21}, {x:-3.45, y:154.98, z:2.21}],
  [{x:34.96, y:87.23, z:4.74}, {x:32.02, y:84.79, z:2.22}, {x:33.29, y:89.54, z:4.14}],
  [{x:33.29, y:89.54, z:4.14}, {x:31.92, y:94.01, z:1.43}, {x:35.69, y:93.76, z:-0.06}],
  [{x:34.96, y:87.23, z:4.74}, {x:33.29, y:89.54, z:4.14}, {x:35.69, y:93.76, z:-0.06}],
  [{x:-20.34, y:140.73, z:-0.07}, {x:-24.79, y:138.1, z:-5.73}, {x:-18.73, y:147.28, z:-4.81}],
  [{x:-18.73, y:147.28, z:-4.81}, {x:-24.79, y:138.1, z:-5.73}, {x:-17.75, y:141.37, z:-11.91}],
  [{x:34.8, y:92.64, z:-3.71}, {x:35.69, y:93.76, z:-0.06}, {x:32.23, y:114.01, z:-4.06}],
  [{x:35.69, y:93.76, z:-0.06}, {x:37.07, y:80.69, z:4.7}, {x:34.96, y:87.23, z:4.74}],
  [{x:35.56, y:79.58, z:4.79}, {x:32.02, y:84.79, z:2.22}, {x:34.96, y:87.23, z:4.74}],
  [{x:35.24, y:79.42, z:1.54}, {x:32.02, y:84.79, z:2.22}, {x:35.56, y:79.58, z:4.79}],
  [{x:37.07, y:80.69, z:4.7}, {x:35.56, y:79.58, z:4.79}, {x:34.96, y:87.23, z:4.74}],
  [{x:36.91, y:82.3, z:-0.36}, {x:33.37, y:83.32, z:-2.28}, {x:34.88, y:80.56, z:-1.02}],
  [{x:35.69, y:93.76, z:-0.06}, {x:36.91, y:82.3, z:-0.36}, {x:37.07, y:80.69, z:4.7}],
  [{x:33.29, y:89.54, z:4.14}, {x:32.02, y:84.79, z:2.22}, {x:31.92, y:94.01, z:1.43}],
  [{x:32.02, y:84.79, z:2.22}, {x:35.24, y:79.42, z:1.54}, {x:34.88, y:80.56, z:-1.02}],
  [{x:35.24, y:79.42, z:1.54}, {x:35.56, y:79.58, z:4.79}, {x:37.07, y:80.69, z:4.7}],
  [{x:34.8, y:92.64, z:-3.71}, {x:33.37, y:83.32, z:-2.28}, {x:36.91, y:82.3, z:-0.36}],
  [{x:-5.55, y:60.2, z:1.32}, {x:-0.29, y:81.68, z:-1.88}, {x:-5.6, y:51.18, z:-4.28}],
  [{x:-0.29, y:81.68, z:-1.88}, {x:-2.56, y:81.23, z:-11.18}, {x:-9.51, y:46.2, z:-11.28}],
  [{x:-0.29, y:81.68, z:-1.88}, {x:-9.51, y:46.2, z:-11.28}, {x:-5.6, y:51.18, z:-4.28}],
  [{x:-18.52, y:73.06, z:1.33}, {x:-16.96, y:53.05, z:-5.05}, {x:-14.84, y:86.67, z:-10.51}],
  [{x:-11.52, y:73.59, z:7.98}, {x:-5.55, y:60.2, z:1.32}, {x:-12.17, y:42.15, z:-1.95}],
  [{x:-11.52, y:73.59, z:7.98}, {x:-12.17, y:42.15, z:-1.95}, {x:-18.52, y:73.06, z:1.33}],
  [{x:-24.79, y:138.1, z:-5.73}, {x:-31.48, y:115.81, z:-5.59}, {x:-17.75, y:141.37, z:-11.91}],
  [{x:-17.75, y:141.37, z:-11.91}, {x:-31.48, y:115.81, z:-5.59}, {x:-28.71, y:112.12, z:-9.14}],
  [{x:-2.12, y:84.1, z:7.3}, {x:-11.52, y:73.59, z:7.98}, {x:-13.08, y:95.32, z:6.43}],
  [{x:-18.52, y:73.06, z:1.33}, {x:-12.17, y:42.15, z:-1.95}, {x:-15.41, y:42.67, z:-2.11}],
  [{x:-16.96, y:53.05, z:-5.05}, {x:-18.52, y:73.06, z:1.33}, {x:-15.41, y:42.67, z:-2.11}],
  [{x:-18.52, y:73.06, z:1.33}, {x:-13.08, y:95.32, z:6.43}, {x:-11.52, y:73.59, z:7.98}],
  [{x:-28.22, y:117.11, z:-2.22}, {x:-31.48, y:115.81, z:-5.59}, {x:-24.79, y:138.1, z:-5.73}],
  [{x:-2.12, y:84.1, z:7.3}, {x:-5.55, y:60.2, z:1.32}, {x:-11.52, y:73.59, z:7.98}],
  [{x:-19.2, y:131.29, z:0.95}, {x:-28.22, y:117.11, z:-2.22}, {x:-24.79, y:138.1, z:-5.73}],
  [{x:11.36, y:111.23, z:5.69}, {x:11.97, y:130.4, z:7.73}, {x:16.9, y:129.04, z:-8.16}],
  [{x:-16.96, y:128.87, z:-8.25}, {x:-24.05, y:116.19, z:-2.87}, {x:-19.2, y:131.29, z:0.95}],
  [{x:-28.71, y:112.12, z:-9.14}, {x:-18.63, y:132.27, z:-11.45}, {x:-17.75, y:141.37, z:-11.91}],
  [{x:-8.69, y:111.57, z:-8.47}, {x:8.86, y:112.13, z:-8.49}, {x:-9.07, y:133.45, z:-16.92}],
  [{x:-9.07, y:133.45, z:-16.92}, {x:-13.01, y:123.05, z:-11.22}, {x:-8.69, y:111.57, z:-8.47}],
  [{x:8.86, y:112.13, z:-8.49}, {x:17.95, y:131.19, z:-11.0}, {x:9.75, y:134.32, z:-16.79}],
  [{x:17.95, y:131.19, z:-11.0}, {x:8.86, y:112.13, z:-8.49}, {x:16.9, y:129.04, z:-8.16}],
  [{x:3.51, y:131.96, z:10.76}, {x:11.97, y:130.4, z:7.73}, {x:11.36, y:111.23, z:5.69}],
  [{x:18.91, y:132.39, z:0.83}, {x:23.5, y:116.08, z:-2.73}, {x:16.9, y:129.04, z:-8.16}],
  [{x:-16.96, y:128.87, z:-8.25}, {x:-13.01, y:123.05, z:-11.22}, {x:-18.63, y:132.27, z:-11.45}],
  [{x:-16.96, y:128.87, z:-8.25}, {x:-13.35, y:109.79, z:-2.09}, {x:-13.01, y:123.05, z:-11.22}],
  [{x:29.4, y:117.63, z:-0.4}, {x:18.91, y:132.39, z:0.83}, {x:18.57, y:140.73, z:-0.07}],
  [{x:29.4, y:117.63, z:-0.4}, {x:18.57, y:140.73, z:-0.07}, {x:27.69, y:129.55, z:-5.45}],
  [{x:-13.35, y:109.79, z:-2.09}, {x:-16.96, y:128.87, z:-8.25}, {x:-11.56, y:111.27, z:5.8}],
  [{x:27.69, y:129.55, z:-5.45}, {x:21.09, y:135.11, z:-11.24}, {x:28.18, y:111.52, z:-9.83}],
  [{x:-14.84, y:86.67, z:-10.51}, {x:-13.35, y:109.79, z:-2.09}, {x:-18.52, y:73.06, z:1.33}],
  [{x:13.14, y:109.79, z:-2.09}, {x:16.9, y:129.04, z:-8.16}, {x:8.86, y:112.13, z:-8.49}],
  [{x:-16.96, y:128.87, z:-8.25}, {x:-18.63, y:132.27, z:-11.45}, {x:-28.71, y:112.12, z:-9.14}],
  [{x:8.85, y:91.09, z:9.28}, {x:5.14, y:105.01, z:9.27}, {x:11.36, y:111.23, z:5.69}],
  [{x:8.85, y:91.09, z:9.28}, {x:11.36, y:111.23, z:5.69}, {x:18.54, y:73.06, z:1.34}],
  [{x:-2.12, y:84.1, z:7.3}, {x:5.14, y:105.01, z:9.27}, {x:8.85, y:91.09, z:9.28}],
  [{x:-6.08, y:91.58, z:-14.06}, {x:-9.66, y:103.11, z:-9.98}, {x:-14.84, y:86.67, z:-10.51}],
  [{x:13.14, y:109.79, z:-2.09}, {x:18.54, y:73.06, z:1.34}, {x:11.36, y:111.23, z:5.69}],
  [{x:13.14, y:109.79, z:-2.09}, {x:11.36, y:111.23, z:5.69}, {x:16.9, y:129.04, z:-8.16}],
  [{x:5.14, y:105.01, z:9.27}, {x:-3.08, y:110.12, z:10.2}, {x:3.51, y:131.96, z:10.76}],
  [{x:-13.35, y:109.79, z:-2.09}, {x:-9.66, y:103.11, z:-9.98}, {x:-8.69, y:111.57, z:-8.47}],
  [{x:11.36, y:111.23, z:5.69}, {x:5.14, y:105.01, z:9.27}, {x:3.51, y:131.96, z:10.76}],
  [{x:-14.84, y:86.67, z:-10.51}, {x:-9.66, y:103.11, z:-9.98}, {x:-13.35, y:109.79, z:-2.09}],
  [{x:-0.22, y:99.05, z:-11.54}, {x:6.19, y:92.33, z:-13.85}, {x:9.68, y:103.12, z:-9.97}],
  [{x:9.68, y:103.12, z:-9.97}, {x:6.19, y:92.33, z:-13.85}, {x:14.36, y:86.8, z:-11.24}],
  [{x:-13.01, y:123.05, z:-11.22}, {x:-13.35, y:109.79, z:-2.09}, {x:-8.69, y:111.57, z:-8.47}],
  [{x:8.86, y:112.13, z:-8.49}, {x:9.68, y:103.12, z:-9.97}, {x:13.14, y:109.79, z:-2.09}],
  [{x:14.36, y:86.8, z:-11.24}, {x:13.14, y:109.79, z:-2.09}, {x:9.68, y:103.12, z:-9.97}],
  [{x:12.19, y:42.1, z:-1.96}, {x:14.87, y:10.9, z:-4.45}, {x:7.94, y:30.17, z:-10.24}],
  [{x:11.44, y:15.46, z:-8.64}, {x:7.94, y:30.17, z:-10.24}, {x:14.87, y:10.9, z:-4.45}],
  [{x:16.44, y:0.0, z:-13.34}, {x:17.58, y:9.81, z:-9.1}, {x:13.33, y:12.02, z:-12.33}],
  [{x:-3.08, y:110.12, z:10.2}, {x:5.14, y:105.01, z:9.27}, {x:-2.12, y:84.1, z:7.3}],
  [{x:28.18, y:111.52, z:-9.83}, {x:17.95, y:131.19, z:-11.0}, {x:16.9, y:129.04, z:-8.16}],
  [{x:19.42, y:4.3, z:0.32}, {x:13.53, y:4.3, z:4.43}, {x:14.87, y:10.9, z:-4.45}],
  [{x:23.5, y:116.08, z:-2.73}, {x:31.73, y:92.65, z:-3.16}, {x:28.18, y:111.52, z:-9.83}],
  [{x:31.73, y:92.65, z:-3.16}, {x:34.8, y:92.64, z:-3.71}, {x:28.18, y:111.52, z:-9.83}],
  [{x:19.42, y:4.3, z:0.32}, {x:16.37, y:3.4, z:9.94}, {x:13.53, y:4.3, z:4.43}],
  [{x:-11.49, y:0.0, z:-3.66}, {x:-19.45, y:0.0, z:-3.11}, {x:-13.86, y:0.0, z:12.08}],
  [{x:11.43, y:0.0, z:-11.73}, {x:19.47, y:0.0, z:-3.11}, {x:16.44, y:0.0, z:-13.34}],
  [{x:19.47, y:0.0, z:-3.11}, {x:11.43, y:0.0, z:-11.73}, {x:11.51, y:0.0, z:-3.66}],
  [{x:19.47, y:0.0, z:-3.11}, {x:11.51, y:0.0, z:-3.66}, {x:13.88, y:0.0, z:12.01}],
  [{x:28.18, y:111.52, z:-9.83}, {x:16.9, y:129.04, z:-8.16}, {x:23.5, y:116.08, z:-2.73}],
  [{x:13.88, y:0.0, z:12.01}, {x:16.37, y:3.4, z:9.94}, {x:21.87, y:0.0, z:9.52}],
  [{x:32.23, y:114.01, z:-4.06}, {x:29.4, y:117.63, z:-0.4}, {x:27.69, y:129.55, z:-5.45}],
  [{x:35.69, y:93.76, z:-0.06}, {x:31.92, y:94.01, z:1.43}, {x:29.4, y:117.63, z:-0.4}],
  [{x:35.69, y:93.76, z:-0.06}, {x:29.4, y:117.63, z:-0.4}, {x:32.23, y:114.01, z:-4.06}],
  [{x:13.88, y:0.0, z:12.01}, {x:21.87, y:0.0, z:9.52}, {x:19.47, y:0.0, z:-3.11}],
  [{x:21.87, y:0.0, z:9.52}, {x:16.37, y:3.4, z:9.94}, {x:19.42, y:4.3, z:0.32}],
  [{x:32.23, y:114.01, z:-4.06}, {x:27.69, y:129.55, z:-5.45}, {x:28.18, y:111.52, z:-9.83}],
  [{x:19.47, y:0.0, z:-3.11}, {x:21.87, y:0.0, z:9.52}, {x:19.42, y:4.3, z:0.32}],
  [{x:32.23, y:114.01, z:-4.06}, {x:28.18, y:111.52, z:-9.83}, {x:34.8, y:92.64, z:-3.71}],
  [{x:19.44, y:31.72, z:-8.19}, {x:14.87, y:10.9, z:-4.45}, {x:15.43, y:42.67, z:-2.11}],
  [{x:23.5, y:116.08, z:-2.73}, {x:31.92, y:94.01, z:1.43}, {x:31.73, y:92.65, z:-3.16}],
  [{x:13.33, y:12.02, z:-12.33}, {x:17.58, y:9.81, z:-9.1}, {x:17.93, y:32.42, z:-13.03}],
  [{x:23.5, y:116.08, z:-2.73}, {x:29.4, y:117.63, z:-0.4}, {x:31.92, y:94.01, z:1.43}],
  [{x:19.47, y:0.0, z:-3.11}, {x:19.42, y:4.3, z:0.32}, {x:17.58, y:9.81, z:-9.1}],
  [{x:19.47, y:0.0, z:-3.11}, {x:17.58, y:9.81, z:-9.1}, {x:16.44, y:0.0, z:-13.34}],
  [{x:19.44, y:31.72, z:-8.19}, {x:17.93, y:32.42, z:-13.03}, {x:17.58, y:9.81, z:-9.1}],
  [{x:14.87, y:10.9, z:-4.45}, {x:17.58, y:9.81, z:-9.1}, {x:19.42, y:4.3, z:0.32}],
  [{x:-20.34, y:140.73, z:-0.07}, {x:-18.73, y:147.28, z:-4.81}, {x:-6.8, y:137.5, z:8.41}],
  [{x:14.87, y:10.9, z:-4.45}, {x:19.44, y:31.72, z:-8.19}, {x:17.58, y:9.81, z:-9.1}],
  [{x:33.37, y:83.32, z:-2.28}, {x:31.73, y:92.65, z:-3.16}, {x:32.02, y:84.79, z:2.22}],
  [{x:-28.22, y:117.11, z:-2.22}, {x:-19.2, y:131.29, z:0.95}, {x:-24.05, y:116.19, z:-2.87}],
  [{x:33.37, y:83.32, z:-2.28}, {x:32.02, y:84.79, z:2.22}, {x:34.88, y:80.56, z:-1.02}],
  [{x:-24.79, y:138.1, z:-5.73}, {x:-20.34, y:140.73, z:-0.07}, {x:-19.2, y:131.29, z:0.95}],
  [{x:-12.81, y:131.21, z:8.0}, {x:-6.8, y:137.5, z:8.41}, {x:-3.08, y:110.12, z:10.2}],
  [{x:9.75, y:134.32, z:-16.79}, {x:-0.17, y:131.97, z:-15.23}, {x:8.86, y:112.13, z:-8.49}],
  [{x:3.33, y:147.61, z:-14.57}, {x:-0.17, y:131.97, z:-15.23}, {x:9.75, y:134.32, z:-16.79}],
  [{x:-6.8, y:137.5, z:8.41}, {x:-12.81, y:131.21, z:8.0}, {x:-20.34, y:140.73, z:-0.07}],
  [{x:-7.92, y:30.17, z:-10.24}, {x:-9.51, y:46.2, z:-11.28}, {x:-12.76, y:32.3, z:-15.34}],
  [{x:-8.24, y:42.01, z:-7.97}, {x:-9.51, y:46.2, z:-11.28}, {x:-7.92, y:30.17, z:-10.24}],
  [{x:-12.17, y:42.15, z:-1.95}, {x:-8.24, y:42.01, z:-7.97}, {x:-7.92, y:30.17, z:-10.24}],
  [{x:-14.98, y:11.23, z:-4.79}, {x:-19.42, y:31.72, z:-8.19}, {x:-15.41, y:42.67, z:-2.11}],
  [{x:8.86, y:112.13, z:-8.49}, {x:-0.17, y:131.97, z:-15.23}, {x:-9.07, y:133.45, z:-16.92}],
  [{x:-17.75, y:141.37, z:-11.91}, {x:-9.07, y:133.45, z:-16.92}, {x:3.33, y:147.61, z:-14.57}],
  [{x:-14.98, y:11.23, z:-4.79}, {x:-12.17, y:42.15, z:-1.95}, {x:-7.92, y:30.17, z:-10.24}],
  [{x:-0.17, y:131.97, z:-15.23}, {x:3.33, y:147.61, z:-14.57}, {x:-9.07, y:133.45, z:-16.92}],
  [{x:-11.42, y:15.46, z:-8.64}, {x:-14.98, y:11.23, z:-4.79}, {x:-7.92, y:30.17, z:-10.24}],
  [{x:-11.56, y:111.27, z:5.8}, {x:-12.81, y:131.21, z:8.0}, {x:-3.08, y:110.12, z:10.2}],
  [{x:-16.96, y:128.87, z:-8.25}, {x:-12.81, y:131.21, z:8.0}, {x:-11.56, y:111.27, z:5.8}],
  [{x:-19.2, y:131.29, z:0.95}, {x:-20.34, y:140.73, z:-0.07}, {x:-12.81, y:131.21, z:8.0}],
  [{x:-12.76, y:32.3, z:-15.34}, {x:-13.31, y:12.02, z:-12.33}, {x:-7.92, y:30.17, z:-10.24}],
  [{x:-7.92, y:30.17, z:-10.24}, {x:-13.31, y:12.02, z:-12.33}, {x:-11.42, y:15.46, z:-8.64}],
  [{x:-16.96, y:128.87, z:-8.25}, {x:-19.2, y:131.29, z:0.95}, {x:-12.81, y:131.21, z:8.0}],
  [{x:-13.31, y:12.02, z:-12.33}, {x:-12.76, y:32.3, z:-15.34}, {x:-17.91, y:32.42, z:-13.03}],
  [{x:-17.75, y:141.37, z:-11.91}, {x:-18.63, y:132.27, z:-11.45}, {x:-9.07, y:133.45, z:-16.92}],
  [{x:-9.07, y:133.45, z:-16.92}, {x:-18.63, y:132.27, z:-11.45}, {x:-13.01, y:123.05, z:-11.22}],
  [{x:-21.86, y:0.0, z:9.58}, {x:-19.45, y:0.0, z:-3.11}, {x:-19.26, y:5.4, z:0.36}],
  [{x:-13.78, y:4.9, z:3.64}, {x:-19.26, y:5.4, z:0.36}, {x:-14.98, y:11.23, z:-4.79}],
  [{x:-19.26, y:5.4, z:0.36}, {x:-13.78, y:4.9, z:3.64}, {x:-16.48, y:2.9, z:10.58}],
  [{x:-16.48, y:2.9, z:10.58}, {x:-21.86, y:0.0, z:9.58}, {x:-19.26, y:5.4, z:0.36}],
  [{x:-3.08, y:110.12, z:10.2}, {x:-6.8, y:137.5, z:8.41}, {x:3.51, y:131.96, z:10.76}],
  [{x:-19.45, y:0.0, z:-3.11}, {x:-21.86, y:0.0, z:9.58}, {x:-13.86, y:0.0, z:12.08}],
  [{x:5.62, y:159.98, z:-7.54}, {x:0.42, y:174.34, z:-12.68}, {x:-2.67, y:161.54, z:-10.64}],
  [{x:-19.42, y:31.72, z:-8.19}, {x:-14.98, y:11.23, z:-4.79}, {x:-17.57, y:9.81, z:-9.1}],
  [{x:-17.57, y:9.81, z:-9.1}, {x:-19.26, y:5.4, z:0.36}, {x:-19.45, y:0.0, z:-3.11}],
  [{x:-19.45, y:0.0, z:-3.11}, {x:-16.43, y:0.0, z:-13.34}, {x:-17.57, y:9.81, z:-9.1}],
  [{x:-13.31, y:12.02, z:-12.33}, {x:-17.57, y:9.81, z:-9.1}, {x:-16.43, y:0.0, z:-13.34}],
  [{x:-11.41, y:0.0, z:-11.73}, {x:-13.31, y:12.02, z:-12.33}, {x:-16.43, y:0.0, z:-13.34}],
  [{x:-17.91, y:32.42, z:-13.03}, {x:-19.42, y:31.72, z:-8.19}, {x:-17.57, y:9.81, z:-9.1}],
  [{x:-19.26, y:5.4, z:0.36}, {x:-17.57, y:9.81, z:-9.1}, {x:-14.98, y:11.23, z:-4.79}],
  [{x:-19.45, y:0.0, z:-3.11}, {x:-11.49, y:0.0, z:-3.66}, {x:-11.41, y:0.0, z:-11.73}],
  [{x:7.21, y:175.81, z:-7.69}, {x:5.62, y:159.98, z:-7.54}, {x:8.93, y:165.97, z:-3.32}],
  [{x:-16.43, y:0.0, z:-13.34}, {x:-19.45, y:0.0, z:-3.11}, {x:-11.41, y:0.0, z:-11.73}],
  [{x:0.42, y:174.34, z:-12.68}, {x:5.62, y:159.98, z:-7.54}, {x:7.21, y:175.81, z:-7.69}],
  [{x:-17.91, y:32.42, z:-13.03}, {x:-17.57, y:9.81, z:-9.1}, {x:-13.31, y:12.02, z:-12.33}],
  [{x:-14.98, y:11.23, z:-4.79}, {x:-11.49, y:0.0, z:-3.66}, {x:-13.78, y:4.9, z:3.64}],
  [{x:-11.49, y:0.0, z:-3.66}, {x:-13.86, y:0.0, z:12.08}, {x:-13.78, y:4.9, z:3.64}],
  [{x:-9.66, y:103.11, z:-9.98}, {x:-0.22, y:99.05, z:-11.54}, {x:9.68, y:103.12, z:-9.97}],
  [{x:-6.08, y:91.58, z:-14.06}, {x:-0.22, y:99.05, z:-11.54}, {x:-9.66, y:103.11, z:-9.98}],
  [{x:6.19, y:92.33, z:-13.85}, {x:-0.22, y:99.05, z:-11.54}, {x:-6.08, y:91.58, z:-14.06}],
  [{x:-6.08, y:91.58, z:-14.06}, {x:0.64, y:85.75, z:-12.63}, {x:6.19, y:92.33, z:-13.85}],
  [{x:8.86, y:112.13, z:-8.49}, {x:-8.69, y:111.57, z:-8.47}, {x:-9.66, y:103.11, z:-9.98}],
  [{x:7.21, y:175.81, z:-7.69}, {x:0.42, y:180.0, z:-2.63}, {x:0.42, y:174.34, z:-12.68}],
  [{x:-13.35, y:109.79, z:-2.09}, {x:-11.56, y:111.27, z:5.8}, {x:-18.52, y:73.06, z:1.33}],
  [{x:-5.79, y:165.74, z:5.99}, {x:0.69, y:168.11, z:9.89}, {x:0.55, y:156.87, z:8.06}],
  [{x:-13.08, y:95.32, z:6.43}, {x:-18.52, y:73.06, z:1.33}, {x:-11.56, y:111.27, z:5.8}],
  [{x:-9.66, y:103.11, z:-9.98}, {x:9.68, y:103.12, z:-9.97}, {x:8.86, y:112.13, z:-8.49}],
  [{x:0.42, y:180.0, z:-2.63}, {x:7.25, y:175.34, z:1.67}, {x:0.5, y:175.78, z:6.9}],
  [{x:-13.08, y:95.32, z:6.43}, {x:-11.56, y:111.27, z:5.8}, {x:-3.08, y:110.12, z:10.2}],
  [{x:-2.12, y:84.1, z:7.3}, {x:-13.08, y:95.32, z:6.43}, {x:-3.08, y:110.12, z:10.2}],
  [{x:-33.17, y:93.17, z:-3.78}, {x:-28.71, y:112.12, z:-9.14}, {x:-31.48, y:115.81, z:-5.59}],
  [{x:7.25, y:175.34, z:1.67}, {x:6.75, y:166.1, z:5.26}, {x:0.69, y:168.11, z:9.89}],
  [{x:-30.16, y:93.04, z:-2.95}, {x:-33.17, y:93.17, z:-3.78}, {x:-33.07, y:82.17, z:-3.4}],
  [{x:-33.17, y:93.17, z:-3.78}, {x:-30.16, y:93.04, z:-2.95}, {x:-28.71, y:112.12, z:-9.14}],
  [{x:8.93, y:165.97, z:-3.32}, {x:6.75, y:166.1, z:5.26}, {x:7.25, y:175.34, z:1.67}],
  [{x:-24.52, y:112.16, z:-7.62}, {x:-16.96, y:128.87, z:-8.25}, {x:-28.71, y:112.12, z:-9.14}],
  [{x:7.21, y:175.81, z:-7.69}, {x:8.93, y:165.97, z:-3.32}, {x:7.25, y:175.34, z:1.67}],
  [{x:-33.17, y:93.17, z:-3.78}, {x:-34.65, y:93.99, z:-0.57}, {x:-33.07, y:82.17, z:-3.4}],
  [{x:-31.48, y:115.81, z:-5.59}, {x:-28.22, y:117.11, z:-2.22}, {x:-34.65, y:93.99, z:-0.57}],
  [{x:-6.7, y:175.25, z:3.19}, {x:0.42, y:180.0, z:-2.63}, {x:0.5, y:175.78, z:6.9}],
  [{x:7.21, y:175.81, z:-7.69}, {x:7.25, y:175.34, z:1.67}, {x:0.42, y:180.0, z:-2.63}],
  [{x:5.62, y:159.98, z:-7.54}, {x:-2.67, y:161.54, z:-10.64}, {x:5.69, y:152.95, z:-8.75}],
  [{x:-2.67, y:161.54, z:-10.64}, {x:-3.02, y:154.6, z:-10.54}, {x:5.69, y:152.95, z:-8.75}],
  [{x:3.33, y:147.61, z:-14.57}, {x:5.69, y:152.95, z:-8.75}, {x:-3.02, y:154.6, z:-10.54}],
  [{x:-30.73, y:94.21, z:1.66}, {x:-34.39, y:88.52, z:3.92}, {x:-34.65, y:93.99, z:-0.57}],
  [{x:-30.73, y:94.21, z:1.66}, {x:-30.61, y:90.14, z:3.83}, {x:-34.39, y:88.52, z:3.92}],
  [{x:20.74, y:143.49, z:-8.79}, {x:20.0, y:147.35, z:-4.74}, {x:3.33, y:147.61, z:-14.57}],
  [{x:-30.73, y:94.21, z:1.66}, {x:-34.65, y:93.99, z:-0.57}, {x:-28.22, y:117.11, z:-2.22}],
  [{x:3.33, y:147.61, z:-14.57}, {x:20.0, y:147.35, z:-4.74}, {x:5.69, y:152.95, z:-8.75}],
  [{x:-31.09, y:84.88, z:4.73}, {x:-30.16, y:93.04, z:-2.95}, {x:-33.07, y:82.17, z:-3.4}],
  [{x:9.75, y:134.32, z:-16.79}, {x:20.74, y:143.49, z:-8.79}, {x:3.33, y:147.61, z:-14.57}],
  [{x:-24.05, y:116.19, z:-2.87}, {x:-30.73, y:94.21, z:1.66}, {x:-28.22, y:117.11, z:-2.22}],
  [{x:-33.17, y:93.17, z:-3.78}, {x:-31.48, y:115.81, z:-5.59}, {x:-34.65, y:93.99, z:-0.57}],
  [{x:-24.05, y:116.19, z:-2.87}, {x:-16.96, y:128.87, z:-8.25}, {x:-24.52, y:112.16, z:-7.62}],
  [{x:-24.52, y:112.16, z:-7.62}, {x:-30.73, y:94.21, z:1.66}, {x:-24.05, y:116.19, z:-2.87}],
  [{x:-6.8, y:137.5, z:8.41}, {x:4.07, y:147.56, z:0.76}, {x:3.51, y:131.96, z:10.76}],
  [{x:0.69, y:168.11, z:9.89}, {x:6.75, y:166.1, z:5.26}, {x:0.55, y:156.87, z:8.06}],
  [{x:4.07, y:147.56, z:0.76}, {x:-2.54, y:148.17, z:0.54}, {x:4.28, y:155.17, z:2.21}],
  [{x:-34.39, y:88.52, z:3.92}, {x:-35.44, y:84.25, z:4.9}, {x:-34.65, y:93.99, z:-0.57}],
  [{x:-3.45, y:154.98, z:2.21}, {x:4.28, y:155.17, z:2.21}, {x:-2.54, y:148.17, z:0.54}],
  [{x:-34.65, y:93.99, z:-0.57}, {x:-35.44, y:84.25, z:4.9}, {x:-35.93, y:82.79, z:-1.1}],
  [{x:6.75, y:166.1, z:5.26}, {x:4.28, y:155.17, z:2.21}, {x:0.55, y:156.87, z:8.06}],
  [{x:8.93, y:165.97, z:-3.32}, {x:4.28, y:155.17, z:2.21}, {x:6.75, y:166.1, z:5.26}],
  [{x:5.62, y:159.98, z:-7.54}, {x:4.28, y:155.17, z:2.21}, {x:8.93, y:165.97, z:-3.32}],
  [{x:9.95, y:139.4, z:6.21}, {x:4.07, y:147.56, z:0.76}, {x:20.0, y:147.35, z:-4.74}],
  [{x:20.0, y:147.35, z:-4.74}, {x:4.07, y:147.56, z:0.76}, {x:5.69, y:152.95, z:-8.75}],
  [{x:5.69, y:152.95, z:-8.75}, {x:4.07, y:147.56, z:0.76}, {x:5.62, y:159.98, z:-7.54}],
  [{x:-33.14, y:80.76, z:5.6}, {x:-34.39, y:88.52, z:3.92}, {x:-31.09, y:84.88, z:4.73}],
  [{x:4.28, y:155.17, z:2.21}, {x:5.62, y:159.98, z:-7.54}, {x:4.07, y:147.56, z:0.76}],
  [{x:9.95, y:139.4, z:6.21}, {x:20.0, y:147.35, z:-4.74}, {x:18.57, y:140.73, z:-0.07}],
  [{x:-34.39, y:88.52, z:3.92}, {x:-30.61, y:90.14, z:3.83}, {x:-31.09, y:84.88, z:4.73}],
  [{x:27.69, y:129.55, z:-5.45}, {x:18.57, y:140.73, z:-0.07}, {x:20.0, y:147.35, z:-4.74}],
  [{x:20.74, y:143.49, z:-8.79}, {x:27.69, y:129.55, z:-5.45}, {x:20.0, y:147.35, z:-4.74}],
  [{x:-33.07, y:82.17, z:-3.4}, {x:-35.93, y:82.79, z:-1.1}, {x:-33.11, y:80.02, z:-2.17}],
  [{x:-34.65, y:93.99, z:-0.57}, {x:-35.93, y:82.79, z:-1.1}, {x:-33.07, y:82.17, z:-3.4}],
  [{x:-33.63, y:79.68, z:1.3}, {x:-31.09, y:84.88, z:4.73}, {x:-33.11, y:80.02, z:-2.17}],
  [{x:-33.11, y:80.02, z:-2.17}, {x:-31.09, y:84.88, z:4.73}, {x:-33.07, y:82.17, z:-3.4}],
  [{x:-35.93, y:82.79, z:-1.1}, {x:-35.44, y:84.25, z:4.9}, {x:-33.14, y:80.76, z:5.6}],
  [{x:-35.44, y:84.25, z:4.9}, {x:-34.39, y:88.52, z:3.92}, {x:-33.14, y:80.76, z:5.6}],
  [{x:-33.14, y:80.76, z:5.6}, {x:-31.09, y:84.88, z:4.73}, {x:-33.63, y:79.68, z:1.3}],
  [{x:-33.14, y:80.76, z:5.6}, {x:-33.63, y:79.68, z:1.3}, {x:-35.93, y:82.79, z:-1.1}],
  [{x:-30.61, y:90.14, z:3.83}, {x:-30.73, y:94.21, z:1.66}, {x:-30.16, y:93.04, z:-2.95}],
  [{x:-33.63, y:79.68, z:1.3}, {x:-33.11, y:80.02, z:-2.17}, {x:-35.93, y:82.79, z:-1.1}],
  [{x:-30.16, y:93.04, z:-2.95}, {x:-31.09, y:84.88, z:4.73}, {x:-30.61, y:90.14, z:3.83}],
  [{x:31.73, y:92.65, z:-3.16}, {x:31.92, y:94.01, z:1.43}, {x:32.02, y:84.79, z:2.22}],
  [{x:36.91, y:82.3, z:-0.36}, {x:34.88, y:80.56, z:-1.02}, {x:35.24, y:79.42, z:1.54}],
  [{x:35.24, y:79.42, z:1.54}, {x:37.07, y:80.69, z:4.7}, {x:36.91, y:82.3, z:-0.36}],
  [{x:-30.16, y:93.04, z:-2.95}, {x:-30.73, y:94.21, z:1.66}, {x:-24.52, y:112.16, z:-7.62}],
  [{x:-28.71, y:112.12, z:-9.14}, {x:-30.16, y:93.04, z:-2.95}, {x:-24.52, y:112.16, z:-7.62}],
  [{x:-6.7, y:175.25, z:3.19}, {x:0.5, y:175.78, z:6.9}, {x:0.69, y:168.11, z:9.89}],
  [{x:-6.7, y:175.25, z:3.19}, {x:0.69, y:168.11, z:9.89}, {x:-5.79, y:165.74, z:5.99}],
];

  function drawTargets3D() {
    if (viewDim !== '3d') return;
    if (!HUMAN_TRIANGLES.length) return;

    const faces = [];
    const color = cssVar('--pulse') || '#22c55e';
    const SCALE = 1;

    function pushFace(verts) {
      const proj = verts.map(v => project3D(v.x, v.y, v.z));
      if (proj.some(p => !p)) return;
      const depth = proj.reduce((s, p) => s + p.z, 0) / proj.length;
      faces.push({ proj, depth });
    }

    for (const n of [1, 2, 3]) {
      const p = livePos[n];
      if (!p || !Number.isFinite(p.x) || !Number.isFinite(p.y)) continue;
      if (p.x === 0 && p.y === 0) continue;

      const wx = clamp(p.x, X_MIN, X_MAX);
      const wz = clamp(p.y, Y_MIN, Y_MAX);

      const angleRad = Number.isFinite(p.heading) ? p.heading : 0;
      const cosA = Math.cos(angleRad);
      const sinA = Math.sin(angleRad);

      for (const tri of HUMAN_TRIANGLES) {
        const v0 = tri[0];
        const v1 = tri[1];
        const v2 = tri[2];

        function transform(v) {
          const lx = v.x * SCALE;
          const ly = v.y * SCALE;
          const lz = v.z * SCALE;

          const rx = lx * cosA + lz * sinA;
          const rz = -lx * sinA + lz * cosA;

          return {
            x: wx + rx,
            y: ly,
            z: wz + rz
          };
        }

        const verts = [transform(v0), transform(v1), transform(v2)];
        pushFace(verts);
      }
    }

    faces.sort((a, b) => b.depth - a.depth);

    ctx.save();
    ctx.strokeStyle = color;
    ctx.fillStyle   = color;

    for (const f of faces) {
      ctx.beginPath();
      ctx.moveTo(f.proj[0].x, f.proj[0].y);
      for (let i = 1; i < f.proj.length; i++) {
        ctx.lineTo(f.proj[i].x, f.proj[i].y);
      }
      ctx.closePath();

      ctx.globalAlpha = 0.20;
      ctx.fill();

      ctx.globalAlpha = 0.4;
      ctx.lineWidth   = 0.5;
      ctx.stroke();
    }

    ctx.restore();
  }

  function drawScene3D(){
  ctx.clearRect(0,0,cvs.width/dpr,cvs.height/dpr);
  updateCamera3D();
  drawGrid3D();
  drawFov3D(MAX_RANGE,false);
  if(detRange>0 && detRange<MAX_RANGE){
    drawFov3D(detRange,true);
  }
  if(viewMode === 'heatmap'){
    drawHeatmap3D();
  }
  drawZones3D();
  drawTargets3D();
  }

  let drawQueued=false;
  function enqueueDraw(){
    if(drawQueued) return;
    drawQueued=true;
    requestAnimationFrame(()=>{ drawQueued=false; draw(); });
  }

  function draw(){
    ctx.clearRect(0,0,cvs.width/dpr,cvs.height/dpr);

    if(viewDim === '3d'){
      drawScene3D();
    } else {
      drawGrid();
      drawFov(MAX_RANGE,false);
      if(detRange>0&&detRange<MAX_RANGE) drawFov(detRange,true);
      if(viewMode === 'heatmap'){
        drawHeatmap2D();
      }
      for(const key of ['1','2','3','excl']){
        const active = currentZone && key===currentZone;
        const style=zoneStyle(key,active);
        if(!active) drawPolygon(zones[key],style);
      }
      if(currentZone && zones[currentZone]){
        drawPolygon(zones[currentZone],zoneStyle(currentZone,true));
        drawHandles(zones[currentZone]);
      }
      drawTargets();
    }

    const showLegend = (viewMode === 'heatmap');
    legend.style.display = showLegend ? 'flex' : 'none';
    if(viewToggle){
      viewToggle.style.display = 'flex';
    }

    viewToggleBtns.forEach(btn=>{
      const v = btn.dataset.view;
      const active = (v === viewDim);
      btn.classList.toggle('active',active);
    });
  }   

  let dragIdx=null, dragWhole=false, lastPX=0, lastPY=0;

  function localPoint(clientX,clientY){
    const r=cvs.getBoundingClientRect();
    const sx=(cvs.width/dpr)/r.width, sy=(cvs.height/dpr)/r.height;
    return {x:(clientX-r.left)*sx,y:(clientY-r.top)*sy};
  }

    function nearestIdx(px,py){
    if(!currentZone) return -1;
    const pts=zones[currentZone];
    if(!pts) return -1;
    let best=-1,dmin=14;
    for(let i=0;i<pts.length;i++){
      const dx=toPxX(pts[i].x)-px, dy=toPxY(pts[i].y)-py;
      const d=Math.hypot(dx,dy);
      if(d<dmin){ dmin=d; best=i; }
    }
    return best;
  }

  function distToSegment(px,py,ax,ay,bx,by){
    const vx=bx-ax, vy=by-ay;
    const wx=px-ax, wy=py-ay;
    const c1=vx*wx+vy*wy;
    if(c1<=0) return Math.hypot(px-ax,py-ay);
    const c2=vx*vx+vy*vy;
    if(c2<=c1) return Math.hypot(px-bx,py-by);
    const t=c1/c2;
    const projx=ax+t*vx, projy=ay+t*vy;
    return Math.hypot(px-projx,py-projy);
  }

  function nearestEdge(px,py){
    if(!currentZone) return {idx:-1,dist:Infinity};
    const pts=zones[currentZone];
    if(!pts || pts.length<2) return {idx:-1,dist:Infinity};

    let bestIdx=-1;
    let dmin=10;

    for(let i=0;i<pts.length;i++){
      const j=(i+1)%pts.length;

      const ax=toPxX(pts[i].x), ay=toPxY(pts[i].y);
      const bx=toPxX(pts[j].x), by=toPxY(pts[j].y);
      const d=distToSegment(px,py,ax,ay,bx,by);
      if(d<dmin){
        dmin=d;
        bestIdx=i;
      }
    }
    return {idx:bestIdx,dist:dmin};
  }

  function pointInPoly(pts,px,py){
    if(!pts||pts.length<3) return false;
    const x=toCmX(px), y=toCmY(py);
    let inside=false;
    for(let i=0,j=pts.length-1;i<pts.length;j=i++){
      const xi=pts[i].x, yi=pts[i].y, xj=pts[j].x, yj=pts[j].y;
      const intersect=((yi>y)!==(yj>y))&&(x< (xj-xi)*(y-yi)/(yj-yi+1e-9)+xi);
      if(intersect) inside=!inside;
    }
    return inside;
  }
  function hitZoneAt(px,py){
    const order=[currentZone,'1','2','3','excl'].filter((v,i,self)=>self.indexOf(v)===i);
    for(const z of order){
      const pts=zones[z];
      if(pointInPoly(pts,px,py)) return z;
    }
    return null;
  }
  function setCurrentZone(z){
    currentZone=z;
    zoneBtns.forEach(b=>b.classList.toggle('active',b.dataset.zone===z));
    setStatus('ok',`${z==='excl'?'Exclusion':'Zone '+z} selected`);
  }

  function pointerDown(px,py,button){
  if(button == null) button = 0;

    if(viewDim==='3d'){
      orbitDragging = true;
      orbitLastX = px;
      orbitLastY = py;
      return;
    }

    lastPX=px;
    lastPY=py;
    dragWhole=false;

    if(!currentZone){
      const hit = hitZoneAt(px,py);
      if(hit){
        setCurrentZone(hit);
        dragWhole=true;
      }
      return;
    }

        const pts=zones[currentZone];
    if(!pts) return;

    if(button === 2){
      const idx = nearestIdx(px,py);
      if(idx >= 0){
        pts.splice(idx, 1);
        dragIdx = null;
        dragWhole = false;
        enqueueDraw();
      }
      return;
    }

    const idx=nearestIdx(px,py);
    if(idx>=0){
      dragIdx=idx;
      enqueueDraw();
      return;
    }

    if(pts.length>=2 && pts.length<MAX_POINTS){
      const edge=nearestEdge(px,py);
      if(edge.idx>=0){
        const x=Math.round(toCmX(px)), y=Math.round(toCmY(py));
        const p={
          x:clamp(x,X_MIN,X_MAX),
          y:clamp(y,Y_MIN,Y_MAX)
        };
        const insertAt=edge.idx+1;
        pts.splice(insertAt,0,p);
        dragIdx=insertAt;
        enqueueDraw();
        return;
      }
    }

    const hit=hitZoneAt(px,py);
    if(hit){
      if(hit!==currentZone){
        setCurrentZone(hit);
      }
      dragWhole=true;
      dragIdx=null;
      return;
    }

    if(pts.length>=MAX_POINTS) return;
    const x=Math.round(toCmX(px)), y=Math.round(toCmY(py));
    pts.push({x:clamp(x,X_MIN,X_MAX),y:clamp(y,Y_MIN,Y_MAX)});
    enqueueDraw();

  }

  function pointerMove(px,py){
    if(viewDim==='3d'){
      if(!orbitDragging) return;
      const dx = px - orbitLastX;
      const dy = py - orbitLastY;
      orbitLastX = px;
      orbitLastY = py;
      ORBIT.azimuth += dx * 0.01;
      ORBIT.elevation += dy * 0.01;
      ORBIT.elevation = clamp(ORBIT.elevation, ORBIT_LIMITS.minElev, ORBIT_LIMITS.maxElev);
      enqueueDraw();
      return;
    }

    if(dragIdx==null && !dragWhole) return;
    if(dragWhole){
      const dx=toCmX(px)-toCmX(lastPX);
      const dy=toCmY(py)-toCmY(lastPY);
      const pts=zones[currentZone];
      let canMove=true;
      for(const p of pts){
        const nx=clamp(p.x+dx,X_MIN,X_MAX);
        const ny=clamp(p.y+dy,Y_MIN,Y_MAX);
        if(nx!==p.x+dx||ny!==p.y+dy){ canMove=false; break; }
      }
      if(canMove){
        for(let i=0;i<pts.length;i++){
          pts[i]={x:pts[i].x+dx,y:pts[i].y+dy};
        }
        lastPX=px;
        lastPY=py;
        enqueueDraw();
      }
      return;
    }
    const pts=zones[currentZone];
    pts[dragIdx]={
      x:Math.round(clamp(toCmX(px),X_MIN,X_MAX)),
      y:Math.round(clamp(toCmY(py),Y_MIN,Y_MAX))
    };
    enqueueDraw();
  }

  function pointerUp(){
    if(viewDim==='3d'){
      orbitDragging=false;
      return;
    }
    dragIdx=null;
    dragWhole=false;
  }

  const loadDeviceEntities=pauseDuring(loadDeviceEntitiesCore);
  const loadDetectionRange=pauseDuring(loadDetectionRangeCore);
  const setDetectionRange=pauseDuring(setDetectionRangeCore);
  const loadZone=pauseDuring(loadZoneCore);
  const loadAll=pauseDuring(loadAllCore);
  const saveCurrentZone=pauseDuring(saveCurrentZoneCore);

  cvs.addEventListener('mousedown',e=>{
  const p=localPoint(e.clientX,e.clientY);
  pointerDown(p.x,p.y, e.button);
  });
  window.addEventListener('mousemove',e=>{
    const p=localPoint(e.clientX,e.clientY);
    pointerMove(p.x,p.y);
  });
  window.addEventListener('mouseup',()=>{ pointerUp(); });
  cvs.addEventListener('contextmenu',e=>e.preventDefault());

  cvs.addEventListener('wheel',e=>{
    if(viewDim!=='3d') return;
    e.preventDefault();
    const delta = e.deltaY || e.wheelDelta || 0;
    if(!delta) return;
    const factor = delta>0 ? 1.1 : 0.9;
    ORBIT.distance = clamp(ORBIT.distance * factor, ORBIT_LIMITS.minDist, ORBIT_LIMITS.maxDist);
    enqueueDraw();
  },{passive:false});

  function touchDistance(t1,t2){
    const dx = t1.clientX - t2.clientX;
    const dy = t1.clientY - t2.clientY;
    return Math.hypot(dx,dy);
  }

  cvs.addEventListener('touchstart',e=>{
    if(viewDim==='3d' && e.touches.length===2){
      pinchZooming = true;
      orbitDragging = false;
      pinchLastDist = touchDistance(e.touches[0], e.touches[1]);
      e.preventDefault();
      return;
    }
    const t=e.touches[0];
    if(!t) return;
    const p=localPoint(t.clientX,t.clientY);
    pointerDown(p.x,p.y, 0);
    e.preventDefault();
  },{passive:false});

  cvs.addEventListener('touchmove',e=>{
    if(viewDim==='3d' && pinchZooming && e.touches.length>=2){
      const d = touchDistance(e.touches[0], e.touches[1]);
      if(d>0 && pinchLastDist>0){
        const factor = pinchLastDist / d;
        ORBIT.distance = clamp(ORBIT.distance * factor, ORBIT_LIMITS.minDist, ORBIT_LIMITS.maxDist);
        enqueueDraw();
      }
      pinchLastDist = d;
      e.preventDefault();
      return;
    }
    const t=e.touches[0];
    if(!t) return;
    const p=localPoint(t.clientX,t.clientY);
    pointerMove(p.x,p.y);
    e.preventDefault();
  },{passive:false});

  cvs.addEventListener('touchend',e=>{
    if(e.touches.length<2){
      pinchZooming=false;
      pinchLastDist=0;
    }
    pointerUp();
  },{passive:true});
  cvs.addEventListener('touchcancel',e=>{
    pinchZooming=false;
    pinchLastDist=0;
    pointerUp();
  },{passive:true});

  zoneBtns.forEach(btn=>{
    btn.addEventListener('click',pauseDuring(async()=>{
      setCurrentZone(btn.dataset.zone);
      if(selectedDevice){
        await loadZoneCore(currentZone);
        enqueueDraw();
      }
    }));
  });

  clearBtn.addEventListener('click',pauseDuring(async()=>{
    if(!currentZone){
      setStatus('err','Select a zone first');
      return;
    }
    zones[currentZone]=[];
    enqueueDraw();
    setStatus('', 'Cleared');
  }));

  saveBtn.addEventListener('click',saveCurrentZone);
  rangeSetBtn.addEventListener('click',setDetectionRange);
  rangeInput.addEventListener('keydown',e=>{
    if(e.key==='Enter') setDetectionRange();
  });

  function setViewModeButtons(mode){
    viewMode = mode;
    liveModeBtn.classList.remove('btn-primary','btn-plain');
    heatmapModeBtn.classList.remove('btn-primary','btn-plain');

    liveModeBtn.classList.add(mode==='live'?'btn-primary':'btn-plain');
    heatmapModeBtn.classList.add(mode==='heatmap'?'btn-primary':'btn-plain');
  }

  liveModeBtn.addEventListener('click',function(){
    setViewModeButtons('live');
    enqueueDraw();
    if(selectedDevice) resumeLive(true);
  });

  async function ensureHeatmapData(){
    if(!selectedDevice) return;
    if(heatmapPositions.length) return;
    const targetEntityIds=entities.filter(e=>
      e.entity_id.endsWith('target_1_x')||e.entity_id.endsWith('target_1_y')||
      e.entity_id.endsWith('target_2_x')||e.entity_id.endsWith('target_2_y')||
      e.entity_id.endsWith('target_3_x')||e.entity_id.endsWith('target_3_y')
    ).map(e=>e.entity_id);
    const hours=Number(heatmapHoursSel.value);
    heatmapPositions=await fetchHistoricalData(targetEntityIds,hours);
    heatmapFieldColor=null;
    heatmapFieldHeight=null;
  }

  async function switchToHeatmap2D(){
    if(!selectedDevice) return;
    setViewModeButtons('heatmap');
    viewDim = '2d';
    await ensureHeatmapData();
  enqueueDraw();
  }

  async function switchToHeatmap3D(){
    if(!selectedDevice) return;
    setViewModeButtons('heatmap');
    viewDim = '3d';
    resetOrbitForHeatmap();
    await ensureHeatmapData();
    enqueueDraw();
  }

  heatmapModeBtn.addEventListener('click', async () => {
    if (!selectedDevice) return;

    if (viewDim === '3d') {
      await switchToHeatmap3D();
    } else {
      await switchToHeatmap2D();
    }
  });

  viewToggleBtns.forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      if(!selectedDevice) return;
      const v = btn.dataset.view;
      if(v === '2d'){
        viewDim = '2d';
        enqueueDraw();
      } else {
        viewDim = '3d';
        resetOrbitForHeatmap();
        if(viewMode === 'heatmap'){
          await ensureHeatmapData();
        }
        enqueueDraw();
      }
    });
  });

  legendSigmaBtns.forEach(btn=>{
    btn.addEventListener('click',()=>{
      const op = btn.dataset.op;
      const step = 0.2;
      const minSigma = 0.3;
      const maxSigma = 2.5;

      if(op === 'minus'){
        TUNE.sigmaScale = clamp(TUNE.sigmaScale - step, minSigma, maxSigma);
      }else if(op === 'plus'){
        TUNE.sigmaScale = clamp(TUNE.sigmaScale + step, minSigma, maxSigma);
      }

      legendSigmaBtns.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');

      heatmapFieldColor=null;
      heatmapFieldHeight=null;
      enqueueDraw();
    });
  });

  heatmapHoursSel.addEventListener('change', async ()=>{
    heatmapPositions=[];
    heatmapFieldColor=null;
    heatmapFieldHeight=null;
    if(viewMode === 'heatmap'){
      if(viewDim === '3d') await switchToHeatmap3D();
      else await switchToHeatmap2D();
    }
  });

  (async()=>{
    try{
      pauseLive();
      await api('api/template',{template:'{{ 1+1 }}'});
      const res=await api('api/template',{template:TPL_LIST});
      const list=typeof res==='string'?JSON.parse(res||'[]'):res;
      sel.innerHTML='';
      list.sort((a,b)=>(a.name||a.device_id).localeCompare(b.name||b.device_id))
        .forEach((d,i)=>{
          const opt=document.createElement('option');
          opt.value=d.device_id;
          opt.textContent=d.name||d.device_id;
          opt.dataset.model=d.model||'';
          if(i===0) opt.selected=true;
          sel.appendChild(opt);
        });
      if(!list.length){
        setStatus('err','No devices found');
        return;
      }
      selectedDevice={
        device_id:sel.value,
        name:sel.options[sel.selectedIndex]?.textContent||sel.value,
        model:sel.options[sel.selectedIndex]?.dataset.model||''
      };
      setStatus('', 'Loading device…');
      await loadDeviceEntities(selectedDevice.device_id);
      await loadAll();
      setStatus('ok','Ready');
    }catch(e){
      setStatus('err','API error: '+(e.message||e));
    }finally{
      const ro=new ResizeObserver(()=>{ syncLayout(); });
      ro.observe(container);
      ro.observe(panelCard);
      window.addEventListener('resize',syncLayout);
      document.addEventListener('visibilitychange',()=>{
        if(document.visibilityState==='hidden') pauseLive();
        else resumeLive(true);
      });
      legendSigmaBtns.forEach(b=>b.classList.remove('active'));
      syncLayout();
      resumeLive(true);
      document.body.style.opacity = '1';
    }
  })();

  sel.addEventListener('change',pauseDuring(async()=>{
    if(!sel.value){
      setStatus('err','No device selected');
      return;
    }
    selectedDevice={
      device_id:sel.value,
      name:sel.options[sel.selectedIndex]?.textContent||sel.value,
      model:sel.options[sel.selectedIndex]?.dataset.model||''
    };
    heatmapPositions=[];
    heatmapFieldColor=null;
    heatmapFieldHeight=null;
    setViewModeButtons('live');
    TUNE.sigmaScale = 1.0;
    viewDim = '2d';
    legendSigmaBtns.forEach(b=>b.classList.remove('active'));
    currentZone = null;
    zoneBtns.forEach(b=>b.classList.remove('active'));
    try{
      setStatus('', 'Loading device…');
      await loadDeviceEntities(selectedDevice.device_id);
      await loadAll();
      setStatus('ok','Ready');
    }catch(e){
      setStatus('err','Load failed: '+(e.message||e));
    }finally{
      syncLayout();
      resumeLive(true);
    }
  }));

})();
</script>
</body>
</html>